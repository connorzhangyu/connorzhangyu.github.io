<!doctype html><html lang=zh><head><title>Mycat :: Hello World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="主从复制 启动 1 .下载jre包
2 下载mycat包
3 打包镜像
Dockerfile
FROM centos # 解压这个包到home下面 ADD server-jre-8u251-linux-x64.tar.gz /home/ ADD ./Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz /home ENV WORKPATH /home/mycat/ WORKDIR $WORKPATH ENV JAVA_HOME /home/jdk1.8.0_251 ENV CLASSPATH $JAVA_HOME/dt.jar:$JAVA_HOME/lib/tools.jar ENV PATH $PATH:$JAVA_HOME/BIN:$CATALINA_HOME/lib:$CATALINA_HOME/bin # 暴露8066端口 EXPOSE 8066 CMD /home/mycat/bin/mycat console 把mycat里的conf 和 logs 从容器中拷贝出来
再挂在两个目录,并启动
docker run -it \ --name mycat \ -p 8066:8066 \ -v /home/anthony/mycat/conf:/home/mycat/conf/ \ -v /home/anthony/mycat/logs:/home/mycat/logs/ \ java1234/mycat:1.0 Running Mycat-server... Removed stale pid file: /home/mycat/logs/mycat.pid wrapper | --> Wrapper Started as Console wrapper | Launching a JVM... jvm 1 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org jvm 1 | Copyright 1999-2006 Tanuki Software, Inc. All Rights Reserved. jvm 1 | jvm 1 | MyCAT Server startup successfully. see logs in logs/mycat.log 配置 schems.xml 定义逻辑库,表,分片节点等内容 rule.xml 定义分片规则 server.xml 定义用户以及系统相关变量 安装mysql5.7 # 从容器中拷贝这些文件 docker cp xxx:/etc/mysql/mysql.conf.d/ /home/anthony/mysql docker cp xxx:/var/log/ /home/anthony/mysql 启动的时候映射这些
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://connorzhangyu.com/posts/mycat/><link rel=stylesheet href=https://connorzhangyu.com/styles.css><link rel="shortcut icon" href=https://connorzhangyu.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://connorzhangyu.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Anthony"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="Mycat"><meta property="og:description" content="主从复制 启动 1 .下载jre包
2 下载mycat包
3 打包镜像
Dockerfile
FROM centos # 解压这个包到home下面 ADD server-jre-8u251-linux-x64.tar.gz /home/ ADD ./Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz /home ENV WORKPATH /home/mycat/ WORKDIR $WORKPATH ENV JAVA_HOME /home/jdk1.8.0_251 ENV CLASSPATH $JAVA_HOME/dt.jar:$JAVA_HOME/lib/tools.jar ENV PATH $PATH:$JAVA_HOME/BIN:$CATALINA_HOME/lib:$CATALINA_HOME/bin # 暴露8066端口 EXPOSE 8066 CMD /home/mycat/bin/mycat console 把mycat里的conf 和 logs 从容器中拷贝出来
再挂在两个目录,并启动
docker run -it \ --name mycat \ -p 8066:8066 \ -v /home/anthony/mycat/conf:/home/mycat/conf/ \ -v /home/anthony/mycat/logs:/home/mycat/logs/ \ java1234/mycat:1.0 Running Mycat-server... Removed stale pid file: /home/mycat/logs/mycat.pid wrapper | --> Wrapper Started as Console wrapper | Launching a JVM... jvm 1 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org jvm 1 | Copyright 1999-2006 Tanuki Software, Inc. All Rights Reserved. jvm 1 | jvm 1 | MyCAT Server startup successfully. see logs in logs/mycat.log 配置 schems.xml 定义逻辑库,表,分片节点等内容 rule.xml 定义分片规则 server.xml 定义用户以及系统相关变量 安装mysql5.7 # 从容器中拷贝这些文件 docker cp xxx:/etc/mysql/mysql.conf.d/ /home/anthony/mysql docker cp xxx:/var/log/ /home/anthony/mysql 启动的时候映射这些
"><meta property="og:url" content="https://connorzhangyu.com/posts/mycat/"><meta property="og:site_name" content="Hello World"><meta property="og:image" content="https://image.runtimes.cc/202404051530979.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Java"><meta property="article:published_time" content="2022-11-19 18:25:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>康纳的记仇小本本</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://connorzhangyu.com/posts/mycat/>Mycat</a></h1><div class=post-meta><time class=post-date>2022-11-19</time><span class=post-author>Anthony</span></div><span class=post-tags>#<a href=https://connorzhangyu.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>&nbsp;
#<a href=https://connorzhangyu.com/tags/mysql/>Mysql</a>&nbsp;
#<a href=https://connorzhangyu.com/tags/java/>Java</a>&nbsp;
</span><img src=https://image.runtimes.cc/202404051530979.jpg class=post-cover alt=" " title="Cover Image"><div class=post-content><div><h1 id=主从复制>主从复制<a href=#主从复制 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=启动>启动<a href=#启动 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>1 .下载jre包</p><p>2 下载mycat包</p><p>3 打包镜像</p><p>Dockerfile</p><pre tabindex=0><code>FROM centos
# 解压这个包到home下面
ADD server-jre-8u251-linux-x64.tar.gz /home/
ADD ./Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz /home
ENV WORKPATH /home/mycat/
WORKDIR $WORKPATH

ENV JAVA_HOME /home/jdk1.8.0_251
ENV CLASSPATH $JAVA_HOME/dt.jar:$JAVA_HOME/lib/tools.jar
ENV PATH $PATH:$JAVA_HOME/BIN:$CATALINA_HOME/lib:$CATALINA_HOME/bin

# 暴露8066端口
EXPOSE 8066
CMD /home/mycat/bin/mycat console
</code></pre><p>把mycat里的conf 和 logs 从容器中拷贝出来</p><p>再挂在两个目录,并启动</p><pre tabindex=0><code>docker run -it \
           --name mycat \
           -p 8066:8066 \
           -v /home/anthony/mycat/conf:/home/mycat/conf/ \
           -v /home/anthony/mycat/logs:/home/mycat/logs/ \
           java1234/mycat:1.0

Running Mycat-server...
Removed stale pid file: /home/mycat/logs/mycat.pid
wrapper  | --&gt; Wrapper Started as Console
wrapper  | Launching a JVM...
jvm 1    | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org
jvm 1    |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.
jvm 1    |
jvm 1    | MyCAT Server startup successfully. see logs in logs/mycat.log
</code></pre><h1 id=配置>配置<a href=#配置 class=hanchor arialabel=Anchor>&#8983;</a></h1><ul><li>schems.xml 定义逻辑库,表,分片节点等内容</li><li>rule.xml 定义分片规则</li><li>server.xml 定义用户以及系统相关变量</li></ul><h1 id=安装mysql57>安装mysql5.7<a href=#安装mysql57 class=hanchor arialabel=Anchor>&#8983;</a></h1><pre tabindex=0><code># 从容器中拷贝这些文件
docker cp xxx:/etc/mysql/mysql.conf.d/ /home/anthony/mysql
docker cp xxx:/var/log/ /home/anthony/mysql
</code></pre><p>启动的时候映射这些</p><h1 id=创建网络>创建网络<a href=#创建网络 class=hanchor arialabel=Anchor>&#8983;</a></h1><pre tabindex=0><code># 可以查看容器的虚拟ip
docker inspect ac7

# 查看网络
docker network ls

# 自定义一个网络模式
# extnetwork 是网络模式的名字
# 172.20.0.1 是网关
docker network create --subnet=172.20.0.0/16 extnetwork
</code></pre><h1 id=mysqlmycat指定网路重建容器>mysql,mycat指定网路,重建容器<a href=#mysqlmycat指定网路重建容器 class=hanchor arialabel=Anchor>&#8983;</a></h1><pre tabindex=0><code># 指定网络模式和ip地址
--net extnetwork --ip 172.20.0.2

docker run -itd \
            --name mysql-master \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD=123456 \
            -v /home/anthony/mysql/mysql.conf.d/:/etc/mysql/conf.d/ \
            -v /home/anthony/mysql/log/:/var/log/ \
            --net extnetwork --ip 172.20.0.2 \
            mysql:5.7

docker run -itd \
            --name mysql-slave \
            -p 3307:3306 \
            -e MYSQL_ROOT_PASSWORD=123456 \
            -v /home/anthony/mysql2/mysql.conf.d/:/etc/mysql/conf.d/ \
            -v /home/anthony/mysql2/log/:/var/log/ \
            --net extnetwork --ip 172.20.0.3 \
            mysql:5.7

docker run -it \
           --name mycat \
           -p 8066:8066 \
           -v /home/anthony/mycat/conf:/home/mycat/conf/ \
           -v /home/anthony/mycat/logs:/home/mycat/logs/ \
           --net extnetwork --ip 172.20.0.4 \
           java1234/mycat:1.0
</code></pre><h1 id=主从配置>主从配置<a href=#主从配置 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>主,在[mysqld]</p><pre tabindex=0><code># 主服务器ID,必须唯一
server-id=2
# 开启和设置二进制日志文件名称
log_bin=mysql-bin
# 要同步的数据库
binlog-do-db=db_java1234
# 不需要同步的数据库
binlog-ignore_db=mysql
binlog-ignore_db=information_schema
binlog-ignore_db=performation_schema
binlog_ignore_db=sys
# 设置logbin格式,mysql默认采用statement,建议使用mixed
binlog_format=MIXED
</code></pre><p>从,在[mysqld]</p><pre tabindex=0><code># 主服务器ID,必须唯一
server-id=3
# 这行是从库需要添加的
relay-log=mysql-relay

# 开启和设置二进制日志文件名称
log_bin=mysql-bin
# 要同步的数据库
binlog-do-db=db_java1234
# 不需要同步的数据库
binlog-ignore_db=mysql
binlog-ignore_db=information_schema
binlog-ignore_db=performation_schema
binlog_ignore_db=sys
# 设置logbin格式,mysql默认采用statement,建议使用mixed
binlog_format=MIXED
</code></pre><h1 id=测试>测试<a href=#测试 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>主从还没有生效</p><pre tabindex=0><code>mysql&gt; show master status;
+------------------+----------+--------------+--------------------------------------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB                                 | Executed_Gtid_Set |
+------------------+----------+--------------+--------------------------------------------------+-------------------+
| mysql-bin.000003 |      357 | db_java1234  | mysql,information_schema,performation_schema,sys |                   |
+------------------+----------+--------------+--------------------------------------------------+-------------------+
1 row in set (0.01 sec)

mysql&gt; show slave status;
Empty set
</code></pre><h1 id=设置用户名>设置用户名<a href=#设置用户名 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>在master执行</p><pre tabindex=0><code># 创建用户名为slave1
# 172.20.0.3从库ip
# 123456 密码
CREATE USER &#39;slave1&#39;@&#39;172.20.0.3&#39; IDENTIFIED BY &#39;123456&#39;;

# 语法:GRANT privileges ON databasename.tablename TO &#39;username&#39;@&#39;host&#39;
# 172.20.0.3 从库
# 两个权限:REPLICATION和SLAVE
# *.* 所有的库和表
GRANT REPLICATION SLAVE ON *.* TO &#39;slave1&#39;@&#39;172.20.0.3&#39;;

# 刷新权限
FLUSH PRIVILEGES;
</code></pre><p>在slave执行</p><pre tabindex=0><code>CHANGE MASTER TO MASTER_HOST=&#39;172.20.0.2&#39;,MASTER_USER=&#39;slave1&#39;,MASTER_PASSWORD=&#39;123456&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,MASTER_LOG_POS=964;

# 开启主从
start slave;
</code></pre><p>在从库执行</p><pre tabindex=0><code>show slave status;
</code></pre><p><img src=https://image.runtimes.cc/202404051430859.png alt></p><p>主要看Slave_io_running =yes</p><p>主要看Slave_sql_running =yes</p><h1 id=读写分离>读写分离<a href=#读写分离 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=schemlxml>scheml.xml<a href=#schemlxml class=hanchor arialabel=Anchor>&#8983;</a></h1><h3 id=schema标签>schema标签<a href=#schema标签 class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code>&lt;schema name=&#34;TESTDB&#34; checkSQLschema=&#34;true&#34; sqlMaxLimit=&#34;100&#34; randomDataNode=&#34;dn1&#34;&gt;
    &lt;!-- auto sharding by id (long) --&gt;
    &lt;!--splitTableNames 启用&lt;table name 属性使用逗号分割配置多个表,即多个表使用这个配置--&gt;
    &lt;table name=&#34;travelrecord,address&#34; dataNode=&#34;dn1,dn2,dn3&#34; rule=&#34;auto-sharding-long&#34; splitTableNames =&#34;true&#34;/&gt;
    &lt;!-- &lt;table name=&#34;oc_call&#34; primaryKey=&#34;ID&#34; dataNode=&#34;dn1$0-743&#34; rule=&#34;latest-month-calldate&#34;
   /&gt; --&gt;
&lt;/schema&gt;
</code></pre><ul><li>name: 配置逻辑库的名称</li><li>checkSQLschema: 当执行<code>select * from T_Account.user</code></li></ul><p>为true时,mycat会把sql转成<code>select * from user</code></p><p>false 会报错</p><ul><li>sqlMaxLimit:最大查询每页条数,如果sql指定了limit,就以sql为准,没有,就以配置为准</li><li>randomDataNode:这个先不用,先改成<code>datanote='dn1'</code></li></ul><h3 id=datanote标签>datanote标签<a href=#datanote标签 class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code>&lt;dataNode name=&#34;dn1&#34; dataHost=&#34;localhost1&#34; database=&#34;db1&#34; /&gt;
&lt;dataNode name=&#34;dn2&#34; dataHost=&#34;localhost1&#34; database=&#34;db2&#34; /&gt;
&lt;dataNode name=&#34;dn3&#34; dataHost=&#34;localhost1&#34; database=&#34;db3&#34; /&gt;
</code></pre><ul><li>name:数据分片节点名称</li><li>dataHost:定义该数据分片节点属于哪台数据库主机</li><li>database:指定哪个数据库,db_java1234</li></ul><h3 id=datahost标签>datahost标签<a href=#datahost标签 class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code>&lt;dataHost name=&#34;localhost1&#34; maxCon=&#34;1000&#34; minCon=&#34;10&#34; balance=&#34;3&#34;
          writeType=&#34;0&#34; dbType=&#34;mysql&#34; dbDriver=&#34;native&#34; switchType=&#34;1&#34;  slaveThreshold=&#34;100&#34;&gt;
    &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;
    &lt;!-- can have multi write hosts --&gt;
    &lt;writeHost host=&#34;hostM1&#34; url=&#34;localhost:3306&#34; user=&#34;root&#34;
               password=&#34;123456&#34;&gt;
    &lt;/writeHost&gt;
    &lt;!-- &lt;writeHost host=&#34;hostM2&#34; url=&#34;localhost:3316&#34; user=&#34;root&#34; password=&#34;123456&#34;/&gt; --&gt;
&lt;/dataHost&gt;
</code></pre><ul><li>name:跟datanote标签的datahost对应</li><li>maxCon 指定每个读写实例连接池的的最大链接,write合readhost标签都会使用这个属性的值来实例化出连接池的最大连接数</li><li>min 最小的连接</li><li>balance:</li><li>0 不开启读写分离,所有读操作都发送到当前可用的writehost上</li><li>1</li><li>2 所有读操作都随机在writehost合readehost上分发</li><li>3 所有读请求随机分发到writehost合readhos</li></ul><h1 id=双组双从>双组双从<a href=#双组双从 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=第二套主从>第二套主从<a href=#第二套主从 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>1.在mysql添加中添加</p><pre tabindex=0><code>log-slave-update=1
auto-increment-increment=2
auto-increment-offset=1
</code></pre><p>2.把mysql文件复制一份mysql3</p><p>3.把mysql3的配置文件修修改这些配置</p><pre tabindex=0><code># 主服务器ID,必须唯一
server-id=5
auto-increment-offset=2
</code></pre><p>4.再创建两个容器,m2 和 s2</p><h1 id=master-和-master同步>master 和 master同步<a href=#master-和-master同步 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>就是相互slave</p><h1 id=测试读写分离>测试读写分离<a href=#测试读写分离 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>插入语句</p><pre tabindex=0><code>insert into test valus(@@hostname)
</code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://connorzhangyu.com/posts/mybatis/><span class=button__icon>←</span>
<span class=button__text>Mybatis</span>
</a></span><span class="button next"><a href=https://connorzhangyu.com/posts/nginx/><span class=button__text>Nginx</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>