<!doctype html><html lang=zh><head><title>Java :: Hello World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='基础知识点 循环标签
如果不在嵌套循环中使用,用了跳转,也就相当于continue一样,没有区别
在嵌套循环中使用才有效果,用了innerLoop之后,可以看到
j=2 的时候是不打印 j=3,程序不会到j=3的时候,因为j=2的时候就已经跳出去了 /** * 0====0 * 0====1 * 1====0 * 1====1 * 2====0 * 2====1 * ------------------- * 0====0 * 0====1 * 0====2 * 0====3 * 1====0 * 1====1 * 1====2 * 1====3 * 2====0 * 2====1 * 2====2 * 2====3 */ public static void main(String[] args) { innerLoop: for (int i = 0; i < 3; i++) { for (int j = 0; j < 4; j++) { if (j == 2) { continue innerLoop; } System.out.println(i+"===="+j); } } } Java常用的API方法 集合/列表/数组/Map 数组拼接 // 把数组风格,再循环添加逗号 String[] split = result.split(" "); StringJoiner stringJoiner = new StringJoiner(","); Arrays.stream(split).forEach(stringJoiner::add); // 字符串数组数字,转成int类型,再转成数组 Arrays.stream(split).mapToInt(Integer::parseInt).toArray() // BigDecimal想加,然后如果为空,就给个0 BigDecimal winAmount = list.stream() .map(UserBetOrderRecord::getWinAmount) .reduce(BigDecimal::add) .map(bigDecimal -> bigDecimal.multiply(new BigDecimal("-1"))) .orElse(BigDecimal.ZERO); 数组转集合 public static void test() { int[] arr = new int[]{4, 3, 2, 1, 12, 21, 11}; // 这样转是有问题的,不是想要的 // java.util.array List<int[]> list = Arrays.asList(arr); System.out.println(list); // 使用Hutool的方法,也不死想要的 // cn.hutool.core.collection List<int[]> ints = CollectionUtil.newArrayList(arr); System.out.println(ints); // 使用Spring的工具包,需要强转,强迫症受不了这种方法 // org.springframework.util.CollectionUtils List<Integer> objects = (List<Integer>) CollectionUtils.arrayToList(arr); System.out.println(objects); } 打印数组/集合/Map private static void test() { int[] arr = {1, 2, 3, 4, 5}; System.out.println(arr); // [I@17211155 System.out.println(Arrays.toString(arr)); // [1, 2, 3, 4, 5] List<Integer> integers = new ArrayList<>(); integers.add(1); integers.add(2); integers.add(3); System.out.println(integers); // [1, 2, 3] HashMap<Integer, String> integerStringHashMap = new HashMap<>(); integerStringHashMap.put(1, "a"); integerStringHashMap.put(2, "b"); integerStringHashMap.put(3, "c"); System.out.println(integerStringHashMap); // {1=a, 2=b, 3=c} } 数组截取 // java.util.Arrays // 从0开始,取出6个数 private static void test() { int[] arr = {1, 2, 3, 4, 5, 6}; int[] ints = Arrays.copyOfRange(arr, 0, 6); System.out.println(Arrays.toString(ints)); } 格式化 数值格式化 private static void test() { String format = String.format("%02d", 2); System.out.println(format); // 02 String format2 = String.format("%02d", 20); System.out.println(format2);	// 20 } 数学 余数/取模 private static void test() { int a = 5; int b = 3; // 使用 % 运算符取余数 int remainder = a % b; System.out.println(remainder); // 2 // 使用 Math.floorMod() 方法取余数 int floorMod = Math.floorMod(a, b); System.out.println(floorMod); // 2 } BigDecimal比较 public static void main(String[] args) { BigDecimal a = new BigDecimal(10); BigDecimal b = new BigDecimal(5); int i = a.compareTo(b); switch (i) { case -1: // 小于 System.out.println("a < b"); break; case 0: // 等于 System.out.println("a = b"); break; case 1: // 大于 System.out.println("a > b"); break; } if (a.compareTo(b) != 0) { System.out.println("a != b"); } if (a.compareTo(b) != -1){ System.out.println("a >= b"); } if (a.compareTo(b) != 1) { System.out.println("a <= b"); } } 时间类型比较 public static void main(String[] args) throws ParseException { SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); Date begin = sdf.parse("2020-01-01 00:01:00"); Date end = sdf.parse("2020-01-01 00:02:00"); // 使用compareTo方法 int i = begin.compareTo(end); switch (i) { case -1: System.out.println("开始时间大于结束时间"); break; case 0: System.out.println("开始时间等于结束时间"); break; case 1: System.out.println("开始时间小于结束时间"); break; } // 使用before和after方法 boolean b = begin.before(end); System.out.println(b); boolean c = begin.after(end); System.out.println(c); } 值传递和引用传递 public class Demo { public static void main(String[] args) { HashMap<Integer, User> ingUserHashMap = new HashMap<Integer, User>(); User user = new User(); user.setId(1); ingUserHashMap.put(1, user); // {1=User(id=1, bigDecimal=10)} System.out.println(ingUserHashMap); // 从map里取值,然后再修改 User user1 = ingUserHashMap.get(1); user1.setBigDecimal(BigDecimal.ONE); // 打印map是修改了的 // {1=User(id=1, bigDecimal=1)} System.out.println(ingUserHashMap); } } @Data @ToString class User{ int id; BigDecimal bigDecimal = BigDecimal.TEN; } Lambda 给集合分组
'><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://connorzhangyu.com/posts/java/><link rel=stylesheet href=https://connorzhangyu.com/styles.css><link rel="shortcut icon" href=https://connorzhangyu.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://connorzhangyu.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Anthony"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="Java"><meta property="og:description" content='基础知识点 循环标签
如果不在嵌套循环中使用,用了跳转,也就相当于continue一样,没有区别
在嵌套循环中使用才有效果,用了innerLoop之后,可以看到
j=2 的时候是不打印 j=3,程序不会到j=3的时候,因为j=2的时候就已经跳出去了 /** * 0====0 * 0====1 * 1====0 * 1====1 * 2====0 * 2====1 * ------------------- * 0====0 * 0====1 * 0====2 * 0====3 * 1====0 * 1====1 * 1====2 * 1====3 * 2====0 * 2====1 * 2====2 * 2====3 */ public static void main(String[] args) { innerLoop: for (int i = 0; i < 3; i++) { for (int j = 0; j < 4; j++) { if (j == 2) { continue innerLoop; } System.out.println(i+"===="+j); } } } Java常用的API方法 集合/列表/数组/Map 数组拼接 // 把数组风格,再循环添加逗号 String[] split = result.split(" "); StringJoiner stringJoiner = new StringJoiner(","); Arrays.stream(split).forEach(stringJoiner::add); // 字符串数组数字,转成int类型,再转成数组 Arrays.stream(split).mapToInt(Integer::parseInt).toArray() // BigDecimal想加,然后如果为空,就给个0 BigDecimal winAmount = list.stream() .map(UserBetOrderRecord::getWinAmount) .reduce(BigDecimal::add) .map(bigDecimal -> bigDecimal.multiply(new BigDecimal("-1"))) .orElse(BigDecimal.ZERO); 数组转集合 public static void test() { int[] arr = new int[]{4, 3, 2, 1, 12, 21, 11}; // 这样转是有问题的,不是想要的 // java.util.array List<int[]> list = Arrays.asList(arr); System.out.println(list); // 使用Hutool的方法,也不死想要的 // cn.hutool.core.collection List<int[]> ints = CollectionUtil.newArrayList(arr); System.out.println(ints); // 使用Spring的工具包,需要强转,强迫症受不了这种方法 // org.springframework.util.CollectionUtils List<Integer> objects = (List<Integer>) CollectionUtils.arrayToList(arr); System.out.println(objects); } 打印数组/集合/Map private static void test() { int[] arr = {1, 2, 3, 4, 5}; System.out.println(arr); // [I@17211155 System.out.println(Arrays.toString(arr)); // [1, 2, 3, 4, 5] List<Integer> integers = new ArrayList<>(); integers.add(1); integers.add(2); integers.add(3); System.out.println(integers); // [1, 2, 3] HashMap<Integer, String> integerStringHashMap = new HashMap<>(); integerStringHashMap.put(1, "a"); integerStringHashMap.put(2, "b"); integerStringHashMap.put(3, "c"); System.out.println(integerStringHashMap); // {1=a, 2=b, 3=c} } 数组截取 // java.util.Arrays // 从0开始,取出6个数 private static void test() { int[] arr = {1, 2, 3, 4, 5, 6}; int[] ints = Arrays.copyOfRange(arr, 0, 6); System.out.println(Arrays.toString(ints)); } 格式化 数值格式化 private static void test() { String format = String.format("%02d", 2); System.out.println(format); // 02 String format2 = String.format("%02d", 20); System.out.println(format2);	// 20 } 数学 余数/取模 private static void test() { int a = 5; int b = 3; // 使用 % 运算符取余数 int remainder = a % b; System.out.println(remainder); // 2 // 使用 Math.floorMod() 方法取余数 int floorMod = Math.floorMod(a, b); System.out.println(floorMod); // 2 } BigDecimal比较 public static void main(String[] args) { BigDecimal a = new BigDecimal(10); BigDecimal b = new BigDecimal(5); int i = a.compareTo(b); switch (i) { case -1: // 小于 System.out.println("a < b"); break; case 0: // 等于 System.out.println("a = b"); break; case 1: // 大于 System.out.println("a > b"); break; } if (a.compareTo(b) != 0) { System.out.println("a != b"); } if (a.compareTo(b) != -1){ System.out.println("a >= b"); } if (a.compareTo(b) != 1) { System.out.println("a <= b"); } } 时间类型比较 public static void main(String[] args) throws ParseException { SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); Date begin = sdf.parse("2020-01-01 00:01:00"); Date end = sdf.parse("2020-01-01 00:02:00"); // 使用compareTo方法 int i = begin.compareTo(end); switch (i) { case -1: System.out.println("开始时间大于结束时间"); break; case 0: System.out.println("开始时间等于结束时间"); break; case 1: System.out.println("开始时间小于结束时间"); break; } // 使用before和after方法 boolean b = begin.before(end); System.out.println(b); boolean c = begin.after(end); System.out.println(c); } 值传递和引用传递 public class Demo { public static void main(String[] args) { HashMap<Integer, User> ingUserHashMap = new HashMap<Integer, User>(); User user = new User(); user.setId(1); ingUserHashMap.put(1, user); // {1=User(id=1, bigDecimal=10)} System.out.println(ingUserHashMap); // 从map里取值,然后再修改 User user1 = ingUserHashMap.get(1); user1.setBigDecimal(BigDecimal.ONE); // 打印map是修改了的 // {1=User(id=1, bigDecimal=1)} System.out.println(ingUserHashMap); } } @Data @ToString class User{ int id; BigDecimal bigDecimal = BigDecimal.TEN; } Lambda 给集合分组
'><meta property="og:url" content="https://connorzhangyu.com/posts/java/"><meta property="og:site_name" content="Hello World"><meta property="og:image" content="https://image.runtimes.cc/202404051529974.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Java"><meta property="article:published_time" content="2022-11-19 18:25:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>康纳的记仇小本本</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://connorzhangyu.com/posts/java/>Java</a></h1><div class=post-meta><time class=post-date>2022-11-19</time><span class=post-author>Anthony</span></div><span class=post-tags>#<a href=https://connorzhangyu.com/tags/java/>Java</a>&nbsp;
#<a href=https://connorzhangyu.com/tags/spring/>Spring</a>&nbsp;
</span><img src=https://image.runtimes.cc/202404051529974.png class=post-cover alt=" " title="Cover Image"><div class=post-content><div><h1 id=基础知识点>基础知识点<a href=#基础知识点 class=hanchor arialabel=Anchor>&#8983;</a></h1><p><strong>循环标签</strong></p><p>如果不在嵌套循环中使用,用了跳转,也就相当于<code>continue</code>一样,没有区别</p><p>在嵌套循环中使用才有效果,用了<code>innerLoop</code>之后,可以看到</p><ul><li>j=2 的时候是不打印</li><li>j=3,程序不会到j=3的时候,因为j=2的时候就已经跳出去了</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * -------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====2
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 0====3
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====2
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1====3
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====1
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====2
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2====3
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    innerLoop:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 3; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0; j <span style=color:#f92672>&lt;</span> 4; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (j <span style=color:#f92672>==</span> 2) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span> innerLoop;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(i<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;====&#34;</span><span style=color:#f92672>+</span>j);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=java常用的api方法>Java常用的API方法<a href=#java常用的api方法 class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=集合列表数组map>集合/列表/数组/Map<a href=#集合列表数组map class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=数组拼接>数组拼接<a href=#数组拼接 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 把数组风格,再循环添加逗号</span>
</span></span><span style=display:flex><span>String<span style=color:#f92672>[]</span> split <span style=color:#f92672>=</span> result.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34; &#34;</span>);
</span></span><span style=display:flex><span>StringJoiner stringJoiner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringJoiner(<span style=color:#e6db74>&#34;,&#34;</span>);
</span></span><span style=display:flex><span>Arrays.<span style=color:#a6e22e>stream</span>(split).<span style=color:#a6e22e>forEach</span>(stringJoiner::add);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 字符串数组数字,转成int类型,再转成数组</span>
</span></span><span style=display:flex><span>Arrays.<span style=color:#a6e22e>stream</span>(split).<span style=color:#a6e22e>mapToInt</span>(Integer::parseInt).<span style=color:#a6e22e>toArray</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// BigDecimal想加,然后如果为空,就给个0</span>
</span></span><span style=display:flex><span>BigDecimal winAmount <span style=color:#f92672>=</span> list.<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>map</span>(UserBetOrderRecord::getWinAmount)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>reduce</span>(BigDecimal::add)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>map</span>(bigDecimal <span style=color:#f92672>-&gt;</span> bigDecimal.<span style=color:#a6e22e>multiply</span>(<span style=color:#66d9ef>new</span> BigDecimal(<span style=color:#e6db74>&#34;-1&#34;</span>)))
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>orElse</span>(BigDecimal.<span style=color:#a6e22e>ZERO</span>);
</span></span></code></pre></div><h3 id=数组转集合>数组转集合<a href=#数组转集合 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> arr <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span>{4, 3, 2, 1, 12, 21, 11};
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// 这样转是有问题的,不是想要的</span>
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// java.util.array</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>[]&gt;</span> list <span style=color:#f92672>=</span> Arrays.<span style=color:#a6e22e>asList</span>(arr);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(list);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>   	<span style=color:#75715e>// 使用Hutool的方法,也不死想要的</span>
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// cn.hutool.core.collection</span>
</span></span><span style=display:flex><span>	  List<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>[]&gt;</span> ints <span style=color:#f92672>=</span> CollectionUtil.<span style=color:#a6e22e>newArrayList</span>(arr);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(ints);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// 使用Spring的工具包,需要强转,强迫症受不了这种方法</span>
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// org.springframework.util.CollectionUtils</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> objects <span style=color:#f92672>=</span> (List<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span>) CollectionUtils.<span style=color:#a6e22e>arrayToList</span>(arr);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(objects);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=打印数组集合map>打印数组/集合/Map<a href=#打印数组集合map class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> arr <span style=color:#f92672>=</span> {1, 2, 3, 4, 5};
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(arr);    <span style=color:#75715e>// [I@17211155</span>
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(Arrays.<span style=color:#a6e22e>toString</span>(arr));   <span style=color:#75715e>// [1, 2, 3, 4, 5]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> integers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    integers.<span style=color:#a6e22e>add</span>(1);
</span></span><span style=display:flex><span>    integers.<span style=color:#a6e22e>add</span>(2);
</span></span><span style=display:flex><span>    integers.<span style=color:#a6e22e>add</span>(3);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(integers);   <span style=color:#75715e>// [1, 2, 3]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HashMap<span style=color:#f92672>&lt;</span>Integer, String<span style=color:#f92672>&gt;</span> integerStringHashMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    integerStringHashMap.<span style=color:#a6e22e>put</span>(1, <span style=color:#e6db74>&#34;a&#34;</span>);
</span></span><span style=display:flex><span>    integerStringHashMap.<span style=color:#a6e22e>put</span>(2, <span style=color:#e6db74>&#34;b&#34;</span>);
</span></span><span style=display:flex><span>    integerStringHashMap.<span style=color:#a6e22e>put</span>(3, <span style=color:#e6db74>&#34;c&#34;</span>);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(integerStringHashMap);   <span style=color:#75715e>// {1=a, 2=b, 3=c}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=数组截取>数组截取<a href=#数组截取 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// java.util.Arrays</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从0开始,取出6个数</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> arr <span style=color:#f92672>=</span> {1, 2, 3, 4, 5, 6};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> ints <span style=color:#f92672>=</span> Arrays.<span style=color:#a6e22e>copyOfRange</span>(arr, 0, 6);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(Arrays.<span style=color:#a6e22e>toString</span>(ints));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=格式化>格式化<a href=#格式化 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=数值格式化>数值格式化<a href=#数值格式化 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>    String format <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%02d&#34;</span>, 2);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(format);  <span style=color:#75715e>// 02</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String format2 <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%02d&#34;</span>, 20);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(format2);	<span style=color:#75715e>// 20</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=数学>数学<a href=#数学 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=余数取模>余数/取模<a href=#余数取模 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> a <span style=color:#f92672>=</span> 5;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> b <span style=color:#f92672>=</span> 3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用 % 运算符取余数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> remainder <span style=color:#f92672>=</span> a <span style=color:#f92672>%</span> b;
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(remainder); <span style=color:#75715e>// 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用 Math.floorMod() 方法取余数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> floorMod <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floorMod</span>(a, b);
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(floorMod); <span style=color:#75715e>// 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=bigdecimal比较>BigDecimal比较<a href=#bigdecimal比较 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>      BigDecimal a <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BigDecimal(10);
</span></span><span style=display:flex><span>      BigDecimal b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BigDecimal(5);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> a.<span style=color:#a6e22e>compareTo</span>(b);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (i) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span>1: <span style=color:#75715e>// 小于</span>
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a &lt; b&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> 0: <span style=color:#75715e>// 等于</span>
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a = b&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> 1: <span style=color:#75715e>// 大于</span>
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a &gt; b&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (a.<span style=color:#a6e22e>compareTo</span>(b) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>          System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a != b&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (a.<span style=color:#a6e22e>compareTo</span>(b) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1){
</span></span><span style=display:flex><span>          System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a &gt;= b&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (a.<span style=color:#a6e22e>compareTo</span>(b) <span style=color:#f92672>!=</span> 1) {
</span></span><span style=display:flex><span>          System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;a &lt;= b&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h2 id=时间类型比较>时间类型比较<a href=#时间类型比较 class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> ParseException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      SimpleDateFormat sdf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleDateFormat(<span style=color:#e6db74>&#34;yyyy-MM-dd HH:mm:ss&#34;</span>);
</span></span><span style=display:flex><span>      Date begin <span style=color:#f92672>=</span> sdf.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2020-01-01 00:01:00&#34;</span>);
</span></span><span style=display:flex><span>      Date end <span style=color:#f92672>=</span> sdf.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2020-01-01 00:02:00&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 使用compareTo方法</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> begin.<span style=color:#a6e22e>compareTo</span>(end);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (i) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span>1:
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;开始时间大于结束时间&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> 0:
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;开始时间等于结束时间&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> 1:
</span></span><span style=display:flex><span>              System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;开始时间小于结束时间&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 使用before和after方法</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> b <span style=color:#f92672>=</span> begin.<span style=color:#a6e22e>before</span>(end);
</span></span><span style=display:flex><span>      System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(b);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> c <span style=color:#f92672>=</span> begin.<span style=color:#a6e22e>after</span>(end);
</span></span><span style=display:flex><span>      System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(c);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h2 id=值传递和引用传递>值传递和引用传递<a href=#值传递和引用传递 class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        HashMap<span style=color:#f92672>&lt;</span>Integer, User<span style=color:#f92672>&gt;</span> ingUserHashMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>Integer, User<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User();
</span></span><span style=display:flex><span>        user.<span style=color:#a6e22e>setId</span>(1);
</span></span><span style=display:flex><span>        ingUserHashMap.<span style=color:#a6e22e>put</span>(1, user);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// {1=User(id=1, bigDecimal=10)}</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(ingUserHashMap);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 从map里取值,然后再修改</span>
</span></span><span style=display:flex><span>        User user1 <span style=color:#f92672>=</span> ingUserHashMap.<span style=color:#a6e22e>get</span>(1);
</span></span><span style=display:flex><span>        user1.<span style=color:#a6e22e>setBigDecimal</span>(BigDecimal.<span style=color:#a6e22e>ONE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 打印map是修改了的</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// {1=User(id=1, bigDecimal=1)}</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(ingUserHashMap);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ToString</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> id;
</span></span><span style=display:flex><span>    BigDecimal bigDecimal <span style=color:#f92672>=</span> BigDecimal.<span style=color:#a6e22e>TEN</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=lambda>Lambda<a href=#lambda class=hanchor arialabel=Anchor>&#8983;</a></h2><p>给集合分组</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        ArrayList<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        list.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> User(1, <span style=color:#e6db74>&#34;anthony&#34;</span>));
</span></span><span style=display:flex><span>        list.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> User(2, <span style=color:#e6db74>&#34;anthony&#34;</span>));
</span></span><span style=display:flex><span>        list.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> User(1, <span style=color:#e6db74>&#34;didid&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 按照用户Id分组</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>Integer, List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;&gt;</span> collect <span style=color:#f92672>=</span> list.<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>groupingBy</span>(User::getId));
</span></span><span style=display:flex><span>        <span style=color:#75715e>// {1=[User(id=1, name=anthony), User(id=1, name=didid)], 2=[User(id=2, name=anthony)]}</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(collect);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1==[User(id=1, name=anthony), User(id=1, name=didid)]</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2==[User(id=2, name=anthony)]</span>
</span></span><span style=display:flex><span>        collect.<span style=color:#a6e22e>forEach</span>((id,userList)<span style=color:#f92672>-&gt;</span>{
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(id<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;==&#34;</span><span style=color:#f92672>+</span>userList);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>{
</span></span><span style=display:flex><span>    Integer id;
</span></span><span style=display:flex><span>    String name;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=threadlocal>ThreadLocal<a href=#threadlocal class=hanchor arialabel=Anchor>&#8983;</a></h1><p><a href=https://juejin.cn/post/7126708538440679460#heading-13>掘金</a></p><h1 id=hashmap>HashMap<a href=#hashmap class=hanchor arialabel=Anchor>&#8983;</a></h1><p>面试八股文&mldr;.</p><p><strong>HashMap和HashTable的区别</strong></p><table><thead><tr><th></th><th>HashMap</th><th>HashTable</th></tr></thead><tbody><tr><td>null值</td><td>允许key,value为null,但最多允许一条记录的key为null</td><td>不允许有null</td></tr><tr><td>安全性</td><td>不安全,<br>Collections.synchronizedMap方法，使HashMap具有线程安全的能力</td><td>线程安全的</td></tr><tr><td>遍历</td><td>Iterator 进行遍历</td><td>使用 Enumeration 进行遍历</td></tr></tbody></table><p><strong>负载因子</strong></p><p>负载因子和扩容机制有关,意思是如果当前容器的容量,达到我们设置的定最大值,就要开始扩容</p><blockquote><p>比如说当前的容器容量是16，负载因子是0.75,16*0.75=12，也就是说，当容量达到了12的时候就会进行扩容操作。</p></blockquote><p>负载因子是1的时候:</p><p>只有当数组的16个一直都填满了,才回扩容,因此在填满的过程中,Hash冲突是避免不了的,也就意味着会出现大量的Hash冲突,底层的红黑树就变得复杂,这种就牺牲了时间,保证空间的利用率</p><p>负载因为是0.5的时候:</p><p>当到达数组一半的就开始扩容,既然填充的元素少了,Hash冲突就变少,那么底层的链表长度和红黑数也就变少,查询效率就高, 原本存储1M的数据,现在需要2M,时间效率提升了,但是空间利用率降低了</p><p><strong>不同JDK版本HashMap的区别</strong></p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>组成</td><td>数组+链表</td><td>数组+链表+红黑树</td></tr><tr><td></td><td>hash 值我们能够快速定位到数组的具体下标，但是之后的话， 需要顺着链表一个个比较下去才能找到我们需要的，时间复杂度取决于链表的长度</td><td>当满足一定条件时，会将链表转换为红黑树</td></tr></tbody></table><p>**链表转红黑树要满足的条件 **</p><ol><li><p>链表中的元素个数>=8,为什么?</p><p>和hashcode碰撞次数的泊松分布有关,主要是为了寻找一种时间和空间的平衡</p><p>红黑数的TreeNode 是 链表中的Node所占空间的2倍,虽然红黑树的查询效率要高于链表,
但是,当链表长度比较小的时候,即使全部遍历,时间复杂度也不会太高</p><p>为什么是8,JDK源码也没有说,只是说做了很多时间,经验的问题</p><p>红黑树转链表的阀值是6,因为:避免红黑树和链表频繁转换</p></li><li><p>当前数组的长度>=64,为什么?</p><p>链表转为红黑树的目的是为了解决链表过长,导致查询和插入的效率慢的问题</p><p>如果要解决这个问题,也可以通过数组扩容,把链接缩短也可以解决问题</p><p>所以在数组长度还不太长的情况,可以先通过数组扩容来解决链表过长的问题</p></li></ol><p>满足这两个条件才会变成红黑树</p><p><strong>HashMap的数组的大小是2的幂</strong></p><blockquote><p>TODO 还是没有搞明白</p><p>只有数组长度是2的幂次方倍才能够确保数组中的每一个位置发生hash冲突的概率是相同的，数组长度减一的二进制码必须全部是1，否则会出现部分位置永远不会发生hash冲突而造成资源浪费</p></blockquote><p><strong>HashMap put流程</strong></p><ol><li>对key进行hash算法，得到一个hashcode</li><li>如果数组长度为0或者为null，对数组进行扩容，得到数组长度n</li><li>通过 key的hashcode&数组长度n 计算出数组下标</li><li>如果数组下标位置中没有数据，将put进来的数据封装Node对象并存到给下标位置</li><li>如果数组下标位置有数据p，即发生hash碰撞，如果key存在，覆盖数据</li><li>如果数据p属于红黑树，会把新数据插入到红黑树中</li><li>如果以上都不是就遍历链表，遍历链表过程中统计链表长度，当链表长度超过8 进行treeifyBin 红黑树化链表</li><li>treeifyBin树化中如果数组长度小于64或数组为null则进行扩容，否则数组长度大于等于64 链表转红黑树</li></ol><p><strong>HashMap 是如何扩容的？</strong></p><ol><li>HashMap的扩容指的就是数组的扩容， 因为数组占用的是连续内存空间，所以数组的扩容其实只能新开一个新的数组，然后把老数组上的元素转移到新数组上来，这样才是数组的扩容</li><li>先新建一个2被数组大小的数组</li><li>然后遍历老数组上的每一个位置，如果这个位置上是一个链表，就把这个链表上的元素转移到新数组上去</li><li>在jdk8中，因为涉及到红黑树，这个其实比较复杂，jdk8中其实还会用到一个双向链表来维护红黑树中的元素，所以jdk8中在转移某个位置上的元素时，会去判断如果这个位置是一个红黑树，那么会遍历该位置的双向链表，遍历双向链表统计哪些元素在扩容完之后还是原位置，哪些元素在扩容之后在新位置，这样遍历完双向链表后，就会得到两个子链表，一个放在原下标位置，一个放在新下标位置，如果原下标位置或新下标位置没有元素，则红黑树不用拆分，否则判断这两个子链表的长度，如果超过8，则转成红黑树放到对应的位置，否则把单向链表放到对应的位置。</li><li>元素转移完了之后，在把新数组对象赋值给HashMap的table属性，老数组会被回收到。</li></ol><h1 id=多线程>多线程<a href=#多线程 class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=线程池>线程池<a href=#线程池 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=手写一个线程池>手写一个线程池<a href=#手写一个线程池 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>1:编写任务类(MyTask),实现Runnable接口;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyTask</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyTask</span>(<span style=color:#66d9ef>int</span> id) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> id;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;即将开始任务:&#34;</span> <span style=color:#f92672>+</span> id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(200);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;完成了任务:&#34;</span> <span style=color:#f92672>+</span> id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;MyTask{&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;id=&#34;</span> <span style=color:#f92672>+</span> id <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;}&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>2:编写线程类(MyWorker),用于执行任务,需要持有所有任务;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyWorker</span> <span style=color:#66d9ef>extends</span> Thread{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> tasks;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyWorker</span>(String name, List<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> tasks) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>setName</span>(name);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tasks</span> <span style=color:#f92672>=</span> tasks;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断集合中是否有任务,如果有就一直运行</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>tasks.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>            Runnable remove <span style=color:#f92672>=</span> tasks.<span style=color:#a6e22e>remove</span>(0);
</span></span><span style=display:flex><span>            remove.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>3:编写线程池类(MyThreadPool),包含提交任务,执行任务的能力;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyThreadPool</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 任务队列</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> Collections.<span style=color:#a6e22e>synchronizedList</span>(<span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;&gt;</span>());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 当前线程数量</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> num;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 核心线程数量</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> corePoolSize;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最大线程数量</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> maxSize;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 任务队列的长度</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> workSize;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyThreadPool</span>(<span style=color:#66d9ef>int</span> corePoolSize, <span style=color:#66d9ef>int</span> maxSize, <span style=color:#66d9ef>int</span> workSize) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>corePoolSize</span> <span style=color:#f92672>=</span> corePoolSize;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>maxSize</span> <span style=color:#f92672>=</span> maxSize;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workSize</span> <span style=color:#f92672>=</span> workSize;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提交方法-将任务添加到队列中</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>submit</span>(Runnable runnable){
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断当前队列的数量,是否超出了最大任务数量</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (tasks.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>&gt;=</span> workSize) {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;任务&#34;</span><span style=color:#f92672>+</span>runnable<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;被丢弃了&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            tasks.<span style=color:#a6e22e>add</span>(runnable);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 执行方法-判断当前线程的数量,决定创建核心线程数量还是非线程数量</span>
</span></span><span style=display:flex><span>            execTask(runnable);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execTask</span>(Runnable runnable) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断当前线程中的线程总数量,是否超出了核心线程数</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>&lt;</span> corePoolSize) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建核心线程</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> MyWorker(<span style=color:#e6db74>&#34;核心线程:&#34;</span><span style=color:#f92672>+</span>num, tasks).<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>            num<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>&lt;</span> maxSize) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建非核心线程</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> MyWorker(<span style=color:#e6db74>&#34;非核心线程:&#34;</span><span style=color:#f92672>+</span>num, tasks).<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>            num<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;任务:&#34;</span><span style=color:#f92672>+</span>runnable<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;被缓存了....&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>4:编写测试类(MyTest),创建线程池对象,提交多个任务测试;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        MyThreadPool myThreadPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyThreadPool(2, 4, 20);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            MyTask myTask <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyTask(i);
</span></span><span style=display:flex><span>            myThreadPool.<span style=color:#a6e22e>submit</span>(myTask);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=内置线程池>内置线程池<a href=#内置线程池 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>ThreadPoolExecutor的使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ThreadPoolExecutor</span>(<span style=color:#66d9ef>int</span> corePoolSize, <span style=color:#75715e>//核心线程数量</span>
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>int</span> maximumPoolSize,<span style=color:#75715e>//     最大线程数</span>
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>long</span> keepAliveTime, <span style=color:#75715e>//       最大空闲时间</span>
</span></span><span style=display:flex><span>                              TimeUnit unit,         <span style=color:#75715e>//        时间单位</span>
</span></span><span style=display:flex><span>                              BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> workQueue,   <span style=color:#75715e>//   任务队列</span>
</span></span><span style=display:flex><span>                              ThreadFactory threadFactory,    <span style=color:#75715e>// 线程工厂</span>
</span></span><span style=display:flex><span>                              RejectedExecutionHandler handler  <span style=color:#75715e>//  饱和处理机制</span>
</span></span><span style=display:flex><span>) 
</span></span></code></pre></div><ol><li>corePoolSize - 线程池核心线程的数量，即使线程是空闲的，核心线程也不会被销毁，除非设置了 allowCoreThreadTimeOut 为 true。</li><li>maximumPoolSize - 线程池中允许的最大线程数。</li><li>keepAliveTime - 非核心线程空闲时的超时时间，超过这个时间就会被销毁。</li><li>unit - keepAliveTime 参数的时间单位。</li><li>workQueue - 用于保存等待执行任务的阻塞队列。<ol><li><strong>SynchronousQueue:</strong> 一个不存储元素的阻塞队列。每个插入操作必须等待另一个线程的对应移除操作，反之亦然。适合于传递性的请求。</li><li><strong>LinkedBlockingQueue:</strong> 一个无界队列，使用链表实现。如果没有指定容量，默认将是 Integer.MAX_VALUE。当任务数量超过核心线程数量时，多余的任务将被放置在队列中等待执行。</li><li><strong>ArrayBlockingQueue:</strong> 一个有界的阻塞队列，使用数组实现。在创建时需要指定容量大小。适合于有界任务队列的场景，如数据库连接池和消息队列等。</li></ol></li><li>threadFactory - 用于创建新线程的工厂。</li><li>handler - 当线程池中的线程数达到最大值且阻塞队列已满时，用来处理新提交的任务的饱和策略。<ol><li><code>AbortPolicy</code>: 默认的策略，将抛出<code>RejectedExecutionException</code>。</li><li><code>CallerRunsPolicy</code>: 当任务被拒绝添加时，会使用当前线程执行被拒绝的任务。</li><li><code>DiscardPolicy</code>: 直接丢弃被拒绝的任务，不提供任何反馈。</li><li><code>DiscardOldestPolicy</code>: 丢弃等待时间最长的任务，然后尝试提交新的任务。</li></ol></li></ol><p>ExecutorService接口的常用方法:</p><table><thead><tr><th>接口名</th><th>作用</th></tr></thead><tbody><tr><td>void shutdown()</td><td>启动一次顺序关闭，执行以前提交的任务，但不接受新任务。</td></tr><tr><td>List<runnable> shutdownNow()</td><td>停止所有正在执行的任务，暂停处理正在等待的任务，并返回等待执行的任务列表。</td></tr><tr><td><t>Future<t> submit(Callable<t> task)</td><td>执行带返回值的任务，返回一个Future对象。</td></tr><tr><td>Future submit(Runnable task)</td><td>执行 Runnable 任务，并返回一个表示该任务的 Future。</td></tr><tr><td><t>Future<t> submit(Runnable task, T result)</td><td>执行 Runnable 任务，并返回一个表示该任务的 Future。</td></tr></tbody></table><h4 id=executorservice接口的的实现类>ExecutorService接口的的实现类<a href=#executorservice接口的的实现类 class=hanchor arialabel=Anchor>&#8983;</a></h4><table><thead><tr><th>方法</th></tr></thead><tbody><tr><td>static ExecutorService newCachedThreadPool()<br>创建一个默认的线程池对象,里面的线程可重用,且在第一次使用时才创建</td></tr><tr><td>static ExecutorService newCachedThreadPool(ThreadFactory threadFactory)<br>线程池中的所有线程都使用ThreadFactory来创建,这样的线程无需手动启动,自动执行;</td></tr><tr><td></td></tr><tr><td>static ExecutorService newFixedThreadPool(int nThreads)<br>创建一个可重用固定线程数的线程池</td></tr><tr><td>static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory)<br>创建一个可重用固定线程数的线程池且线程池中的所有线程都使用ThreadFactory来创建。</td></tr><tr><td></td></tr><tr><td>static ExecutorService newSingleThreadExecutor()<br>创建一个使用单个 worker 线程的 Executor，以无界队列方式来运行该线程。</td></tr><tr><td>static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory)<br>创建一个使用单个 worker 线程的 Executor，且线程池中的所有线程都使用ThreadFactory来创建。</td></tr></tbody></table><h4 id=scheduledexecutorservice任务调度>ScheduledExecutorService任务调度<a href=#scheduledexecutorservice任务调度 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>ScheduledExecutorService是ExecutorService的子接口,具备了延迟运行或定期执行任务的能力</p><table><thead><tr><th>方法()</th></tr></thead><tbody><tr><td>static ScheduledExecutorService newScheduledThreadPool(int corePoolSize)<br>创建一个可重用固定线程数的线程池且允许延迟运行或定期执行任务;</td></tr><tr><td>static ScheduledExecutorService newScheduledThreadPool(int corePoolSize, ThreadFactory threadFactory)<br>创建一个可重用固定线程数的线程池且线程池中的所有线程都使用ThreadFactory来创建,且允许延迟运行或定期执行任务;</td></tr><tr><td></td></tr><tr><td>static ScheduledExecutorService newSingleThreadScheduledExecutor()<br>创建一个单线程执行程序，它允许在给定延迟后运行命令或者定期地执行。</td></tr><tr><td>static ScheduledExecutorService newSingleThreadScheduledExecutor(ThreadFactory threadFactory)<br>创建一个单线程执行程序，它可安排在给定延迟后运行命令或者定期地执行。</td></tr></tbody></table><p>ScheduledExecutorService常用方法如下:</p><table><thead><tr><th>方法</th></tr></thead><tbody><tr><td><v>ScheduledFuture<v> schedule(Callable<v> callable, long delay, TimeUnit unit)<br>延迟时间单位是unit,数量是delay的时间后执行callable。</td></tr><tr><td></td></tr><tr><td>ScheduledFuture schedule(Runnable command, long delay, TimeUnit unit)<br>延迟时间单位是unit,数量是delay的时间后执行command。</td></tr><tr><td></td></tr><tr><td>ScheduledFuture scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit)<br>延迟时间单位是unit,数量是initialDelay的时间后,每间隔period时间重复执行一次command。</td></tr><tr><td></td></tr><tr><td>ScheduledFuture scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit)<br>创建并执行一个在给定初始延迟后首次启用的定期操作，随后，在每一次执行终止和下一次执行开始之间都存在给定的延迟。</td></tr></tbody></table><h4 id=future异步计算结果>Future异步计算结果<a href=#future异步计算结果 class=hanchor arialabel=Anchor>&#8983;</a></h4><table><thead><tr><th></th></tr></thead><tbody><tr><td>boolean cancel(boolean mayInterruptIfRunning)<br>试图取消对此任务的执行。</td></tr><tr><td></td></tr><tr><td>V get()<br>如有必要，等待计算完成，然后获取其结果。</td></tr><tr><td></td></tr><tr><td>V get(long timeout, TimeUnit unit)<br>如有必要，最多等待为使计算完成所给定的时间之后，获取其结果（如果结果可用）。</td></tr><tr><td></td></tr><tr><td>boolean isCancelled()<br>如果在任务正常完成前将其取消，则返回 true。</td></tr><tr><td></td></tr><tr><td>boolean isDone()<br>如果任务已完成，则返回 true。</td></tr></tbody></table><h4 id=代码演示executorservice>代码演示ExecutorService<a href=#代码演示executorservice class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 演示 newCachedThreadPool</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span><span style=color:#75715e>//        test1();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        test2();</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test1</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newCachedThreadPool</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test2</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newCachedThreadPool</span>(<span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(r, <span style=color:#e6db74>&#34;自定义线程名字:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 演示newFixedThreadPool</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span><span style=color:#75715e>//        test1();</span>
</span></span><span style=display:flex><span>        test2();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test1</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(3);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable2(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test2</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(3,<span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(r, <span style=color:#e6db74>&#34;自定义线程名字:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable2(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable2</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable2</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 演示newSingleThreadExecutor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span><span style=color:#75715e>//        test1();</span>
</span></span><span style=display:flex><span>        test2();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test1</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable3(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test2</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>(<span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(r, <span style=color:#e6db74>&#34;自定义线程名字:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable3(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable3</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable3</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ExecutorService接口的shutdown(),shutdownNow(),submit()</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo4</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        test1();</span>
</span></span><span style=display:flex><span>        test2();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test2</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>(<span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(r, <span style=color:#e6db74>&#34;自定义线程名字:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable4(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 立刻关闭线程池,如果线程池中的还有缓存任务,没有执行,则取消执行,并返回这些任务</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> runnables <span style=color:#f92672>=</span> executorService.<span style=color:#a6e22e>shutdownNow</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(runnables);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不能再接收新的方法了,会报错</span>
</span></span><span style=display:flex><span>        executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable4(888));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test1</span>() {
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable4(i));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭线程池,仅仅是不再接收新的任务,以前的任务还会记录执行</span>
</span></span><span style=display:flex><span>        executorService.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不能再接收新的方法了,会报错</span>
</span></span><span style=display:flex><span>        executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyRunable4(888));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable4</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable4</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;MyRunable4{&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;i=&#34;</span> <span style=color:#f92672>+</span> i <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;}&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=代码演示scheduledexecutorservice>代码演示ScheduledExecutorService<a href=#代码演示scheduledexecutorservice class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 演示newScheduledThreadPool,测试延迟执行和重复执行的功能
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取具备延迟执行任务的线程池对象</span>
</span></span><span style=display:flex><span>        ScheduledExecutorService es <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newScheduledThreadPool</span>(3);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建多个任务,并且提交任务,每个任务延迟2s执行</span>
</span></span><span style=display:flex><span>            es.<span style=color:#a6e22e>schedule</span>(<span style=color:#66d9ef>new</span> MyRunable(i), 2, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;结束&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 演示newScheduledThreadPool</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取具备延迟执行任务的线程池对象</span>
</span></span><span style=display:flex><span>        ScheduledExecutorService es <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newScheduledThreadPool</span>(3, <span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(<span style=color:#e6db74>&#34;自定义线程:&#34;</span> <span style=color:#f92672>+</span> n<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建多个任务,并且提交任务,每个任务延迟2s执行</span>
</span></span><span style=display:flex><span>        es.<span style=color:#a6e22e>scheduleAtFixedRate</span>(<span style=color:#66d9ef>new</span> MyRunable2(1), 1,2, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;结束&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable2</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable2</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(1500);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 演示newSingleThreadScheduledExecutor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取具备延迟执行任务的线程池对象</span>
</span></span><span style=display:flex><span>        ScheduledExecutorService es <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadScheduledExecutor</span>( <span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(<span style=color:#e6db74>&#34;自定义线程:&#34;</span> <span style=color:#f92672>+</span> n<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建多个任务,并且提交任务,每个任务延迟2s执行</span>
</span></span><span style=display:flex><span>        es.<span style=color:#a6e22e>scheduleWithFixedDelay</span>(<span style=color:#66d9ef>new</span> MyRunable2(1), 1,2, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;结束&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRunable3</span> <span style=color:#66d9ef>implements</span> Runnable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyRunable3</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(2000);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;执行了任务:&#34;</span><span style=color:#f92672>+</span>i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=代码演示future>代码演示Future<a href=#代码演示future class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo5</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> ExecutionException, InterruptedException, TimeoutException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建线程池对象</span>
</span></span><span style=display:flex><span>        ExecutorService executorService <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newCachedThreadPool</span>();
</span></span><span style=display:flex><span>        Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> submit <span style=color:#f92672>=</span> executorService.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> MyCall(1, 2));
</span></span><span style=display:flex><span><span style=color:#75715e>//        test1(submit);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        test2(submit);</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test2</span>(Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> submit) <span style=color:#66d9ef>throws</span> InterruptedException, ExecutionException, TimeoutException {
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(1000);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;取消任务执行的结果&#34;</span> <span style=color:#f92672>+</span> submit.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 主线程等待超时</span>
</span></span><span style=display:flex><span>        Integer i <span style=color:#f92672>=</span> submit.<span style=color:#a6e22e>get</span>(1, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;任务执行的结果:&#34;</span> <span style=color:#f92672>+</span> i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test1</span>(Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> submit) <span style=color:#66d9ef>throws</span> InterruptedException, ExecutionException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断任务是否完成</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> done <span style=color:#f92672>=</span> submit.<span style=color:#a6e22e>isDone</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;第一次判断任务是否完成:&#34;</span> <span style=color:#f92672>+</span> done);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> cancelled <span style=color:#f92672>=</span> submit.<span style=color:#a6e22e>isCancelled</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;第一次判断任务是否取消:&#34;</span> <span style=color:#f92672>+</span> cancelled);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 无限期等待</span>
</span></span><span style=display:flex><span>        Integer i <span style=color:#f92672>=</span> submit.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;任务执行的结果:&#34;</span> <span style=color:#f92672>+</span> i);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;第二  次判断任务是否完成:&#34;</span> <span style=color:#f92672>+</span> submit.<span style=color:#a6e22e>isDone</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;第一次判断任务是否取消:&#34;</span> <span style=color:#f92672>+</span> submit.<span style=color:#a6e22e>isCancelled</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyCall</span> <span style=color:#66d9ef>implements</span> Callable<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> b;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyCall</span>(<span style=color:#66d9ef>int</span> a, <span style=color:#66d9ef>int</span> b) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> a;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span> <span style=color:#f92672>=</span> b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Integer <span style=color:#a6e22e>call</span>() <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;准备开始计算:&#34;</span>);
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(2000);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;线程:&#34;</span><span style=color:#f92672>+</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;计算完成:&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> a<span style=color:#f92672>+</span>b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=jvm>JVM<a href=#jvm class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=jvm内存结构>JVM内存结构<a href=#jvm内存结构 class=hanchor arialabel=Anchor>&#8983;</a></h2><p><img src=https://image.runtimes.cc/202404051502261.png alt=image-20230825200326130></p><h3 id=程序计数器>程序计数器<a href=#程序计数器 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>虚拟机指令的执行流程:CPU不是不是直接读二进制字节码 , <code>解释器</code>读二进制字节码 转换成 <code>机器码</code>,交给CPU执行</p><p><img src=https://image.runtimes.cc/202404051502586.png alt=image-20230819130100665></p><p>程序计数器的在作用:记住下一跳JVM指令的执行地址</p><p><img src=https://image.runtimes.cc/202404051503947.png alt=image-20230819130536093></p><p>特点:</p><p>线程私有的,</p><p>不会存在内存溢出</p><p><img src=https://image.runtimes.cc/202404051502060.png alt=image-20230819130807803></p><h3 id=虚拟机栈>虚拟机栈<a href=#虚拟机栈 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>每个栈由多个栈桢组成,对应这每次方法调用的时所占用的内存</p><p>每个线程只能有一个活动栈桢,对应着当前正在执行的那个方法</p><p>数据结构,像子弹夹,先进后出,所以不需要GC</p><p>-Xss 设置每个<code>线程</code>栈内存大小,默认1M,内存越大,能使用的线程越少</p><p><img src=https://image.runtimes.cc/202404051502039.png alt=image-20230819131121768></p><p>演示栈桢</p><p><img src=https://image.runtimes.cc/202404051502380.png alt=image-20230819134620208></p><h4 id=演示线程安全>演示线程安全<a href=#演示线程安全 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>方法内的局部变量线程是安全的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 每个线程,有各自的x</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 1000; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            x<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(x);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://image.runtimes.cc/202404051502378.png alt=image-20230819135303041></p><h4 id=演示线程不安全>演示线程不安全<a href=#演示线程不安全 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>如果是静态变量,就不是安全的了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 多线程运行</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>demo</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 1000; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            x<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(x);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://image.runtimes.cc/202404051503889.png alt=image-20230819135343587></p><h4 id=演示栈内存溢出>演示栈内存溢出<a href=#演示栈内存溢出 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>栈桢过大或者过多会溢出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            method();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Throwable e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>	          <span style=color:#75715e>// 19994</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(count);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span>  <span style=color:#a6e22e>method</span>(){
</span></span><span style=display:flex><span>        count<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        method();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// java.lang.StackOverflowError</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	at 栈.Demo2.method(Demo2.java:22)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	at 栈.Demo2.method(Demo2.java:22)</span>
</span></span></code></pre></div><h4 id=线程诊断>线程诊断<a href=#线程诊断 class=hanchor arialabel=Anchor>&#8983;</a></h4><p><strong>1.线程CPU占用高</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 使用top命令</span>
</span></span><span style=display:flex><span>看哪个进程占用CPU过高,只能看到进程,不能看到线程
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看哪个线程占用过高</span>
</span></span><span style=display:flex><span>ps H -eo pid,tid,%cpu | grep 进程id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># jstack 线程id</span>
</span></span><span style=display:flex><span>在具体查找的时候,十进制的线程ID转成16进制
</span></span></code></pre></div><p><strong>2.运行很长时间,得不到结果</strong></p><p>有可能发生死锁了</p><h3 id=本地方法栈>本地方法栈<a href=#本地方法栈 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>native 方法,比如object里的clone方法</p><h3 id=堆>堆<a href=#堆 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>使用-Xmx 设置堆内存空间大小</p><p>特点:</p><p>线程共享的,堆中对象需要考虑线程安全的问题</p><p>有垃圾回收机制</p><h4 id=演示堆内存溢出>演示堆内存溢出<a href=#演示堆内存溢出 class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> List <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        String a <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>                List.<span style=color:#a6e22e>add</span>(a);
</span></span><span style=display:flex><span>                a <span style=color:#f92672>=</span> a <span style=color:#f92672>+</span> a;
</span></span><span style=display:flex><span>                i<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(i);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=演示jmap>演示jmap<a href=#演示jmap class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 查看堆内存使用空间</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 16279是pid</span>
</span></span><span style=display:flex><span>jmap -heap <span style=color:#ae81ff>16279</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Error: -heap option used
</span></span><span style=display:flex><span>Cannot connect to core dump or remote debug server. Use jhsdb jmap instead
</span></span><span style=display:flex><span><span style=color:#75715e># 对于jdk8之后的版本，不能再使用jmap -heap pid的命令了</span>
</span></span><span style=display:flex><span>jhsdb jmap --heap --pid <span style=color:#ae81ff>16279</span>
</span></span></code></pre></div><h4 id=演示jconsole>演示jconsole<a href=#演示jconsole class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;1.....&#34;</span>);
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(30000);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>1028 <span style=color:#f92672>*</span> 1024 <span style=color:#f92672>*</span> 10<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;2.....&#34;</span>);
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(30000);
</span></span><span style=display:flex><span>        bytes <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>gc</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;3.....&#34;</span>);
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(1000000);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>打印1的时候,是刚开始运行,默认的内存占用</p><p>打印2的时候,代码创建了一个10MB数组</p><p>打印3的时候,数据被垃圾回收了,还回收了一些默认的创建的空间,所以内存占用就降下来了</p><p><img src=https://image.runtimes.cc/202404051503025.png alt=image-20230821154126018></p><h4 id=演示jvisualvm>演示jvisualvm<a href=#演示jvisualvm class=hanchor arialabel=Anchor>&#8983;</a></h4><p>点击gc之后,内存占用不下降的情况</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 演示jvisualvm
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ArrayList<span style=color:#f92672>&lt;</span>Persion<span style=color:#f92672>&gt;</span> persions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 200; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            persions.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> Persion());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(99999999999999999L);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Persion</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> big <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>1024 <span style=color:#f92672>*</span> 1024<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>点击<code>Heap Dump</code></p><p><img src=https://image.runtimes.cc/202404051505544.png alt=image-20230821155229892></p><p>仔细找找,就能看到那些数据占用的内存比较多</p><p><img src=https://image.runtimes.cc/202404051506269.png alt=image-20230821155411806></p><h3 id=方法区>方法区<a href=#方法区 class=hanchor arialabel=Anchor>&#8983;</a></h3><p><img src=https://image.runtimes.cc/202404051506319.png alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>演示永久代内存溢出:
</span></span><span style=display:flex><span><span style=color:#75715e># 1.8以前会导致永久代内存溢出</span>
</span></span><span style=display:flex><span>java.lang.OutOfMemoreryError: PermGen space
</span></span><span style=display:flex><span>-XX:MaxPermSize<span style=color:#f92672>=</span>8m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1.8以前会导致元空间内存溢出</span>
</span></span><span style=display:flex><span>java.lang.OutOfMemoreryError: Metaspace
</span></span><span style=display:flex><span>-XX:MaxMetaspaceSize<span style=color:#f92672>=</span>8m
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 没有演示出来</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jdk.internal.org.objectweb.asm.ClassWriter;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jdk.internal.org.objectweb.asm.Opcodes;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 演示元空间内存溢出
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 方法区内存溢出,1.8才有这个版本
</span></span></span><span style=display:flex><span><span style=color:#75715e> * -XX:MaxMetaspaceSize=8m
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ClassLoader:类加载器,可以用来加载类的二进制字节码
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> <span style=color:#66d9ef>extends</span> ClassLoader{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Demo test <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Demo();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10000; i<span style=color:#f92672>++</span>, j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 生成类的二进制字节码</span>
</span></span><span style=display:flex><span>                ClassWriter cw <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClassWriter(0);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 版本号</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 访问修饰符</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 类名</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 包名</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 父类</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 接口名称,这里没有实现接口</span>
</span></span><span style=display:flex><span>                cw.<span style=color:#a6e22e>visit</span>(Opcodes.<span style=color:#a6e22e>V1_8</span>, Opcodes.<span style=color:#a6e22e>ACC_PUBLIC</span>, <span style=color:#e6db74>&#34;Class&#34;</span> <span style=color:#f92672>+</span> i, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#34;java/lang/Object&#34;</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 返回byte数组</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> code <span style=color:#f92672>=</span> cw.<span style=color:#a6e22e>toByteArray</span>();
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 加载类,生成Class对象</span>
</span></span><span style=display:flex><span>                test.<span style=color:#a6e22e>defineClass</span>(<span style=color:#e6db74>&#34;Class&#34;</span> <span style=color:#f92672>+</span> i, code, 0, code.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(j);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>运用的场景:</p><p>Spring和Mybatis都使用到了CGLIB技术,CGLIB也会像上面演示的使用<code>ClassWriter</code>创建对象,创建的对象多了,就会导致方法区异常,所以就移动到直接内存,虽然没啥本质上的作用,只是会影响<code>OOM</code>的时间</p><h5 id=常量池>常量池<a href=#常量池 class=hanchor arialabel=Anchor>&#8983;</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 常量池
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 二进制字节码(类基本信息,常量池,类方法定义,包含了虚拟机指令)
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Hello world&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用命令编译</span>
</span></span><span style=display:flex><span>javap <span style=color:#f92672>-</span>v Demo3.<span style=color:#a6e22e>class</span>
</span></span></code></pre></div><p>编译的结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 以下是类的基本信息</span>
</span></span><span style=display:flex><span>Classfile <span style=color:#f92672>/</span>Users<span style=color:#f92672>/</span>anthony<span style=color:#f92672>/</span>Documents<span style=color:#f92672>/</span>GitHub<span style=color:#f92672>/</span>study<span style=color:#f92672>-</span>java<span style=color:#f92672>/</span>java<span style=color:#f92672>-</span>base<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>classes<span style=color:#f92672>/</span>方法区<span style=color:#f92672>/</span>Demo3.<span style=color:#a6e22e>class</span>
</span></span><span style=display:flex><span>  Last modified 2023年8月23日; size 538 bytes
</span></span><span style=display:flex><span>  MD5 checksum 1aca08c8871c6946b2737975bbf15625
</span></span><span style=display:flex><span>  Compiled from <span style=color:#e6db74>&#34;Demo3.java&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>方法区</span>.<span style=color:#a6e22e>Demo3</span>
</span></span><span style=display:flex><span>  minor version: 0
</span></span><span style=display:flex><span>  major version: 55
</span></span><span style=display:flex><span>  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
</span></span><span style=display:flex><span>  this_class: <span style=color:#960050;background-color:#1e0010>#</span>5                          <span style=color:#75715e>// 方法区/Demo3</span>
</span></span><span style=display:flex><span>  super_class: <span style=color:#960050;background-color:#1e0010>#</span>6                         <span style=color:#75715e>// java/lang/Object</span>
</span></span><span style=display:flex><span>  interfaces: 0, fields: 0, methods: 2, attributes: 1
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>// 常量池</span>
</span></span><span style=display:flex><span>Constant pool:
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>1 <span style=color:#f92672>=</span> Methodref          <span style=color:#960050;background-color:#1e0010>#</span>6.<span style=color:#960050;background-color:#1e0010>#</span>20         <span style=color:#75715e>// java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>2 <span style=color:#f92672>=</span> Fieldref           <span style=color:#960050;background-color:#1e0010>#</span>21.<span style=color:#960050;background-color:#1e0010>#</span>22        <span style=color:#75715e>// java/lang/System.out:Ljava/io/PrintStream;</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>3 <span style=color:#f92672>=</span> String             <span style=color:#960050;background-color:#1e0010>#</span>23            <span style=color:#75715e>// Hello world</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>4 <span style=color:#f92672>=</span> Methodref          <span style=color:#960050;background-color:#1e0010>#</span>24.<span style=color:#960050;background-color:#1e0010>#</span>25        <span style=color:#75715e>// java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>5 <span style=color:#f92672>=</span> Class              <span style=color:#960050;background-color:#1e0010>#</span>26            <span style=color:#75715e>// 方法区/Demo3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>6 <span style=color:#f92672>=</span> Class              <span style=color:#960050;background-color:#1e0010>#</span>27            <span style=color:#75715e>// java/lang/Object</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>7 <span style=color:#f92672>=</span> Utf8               <span style=color:#f92672>&lt;</span>init<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>8 <span style=color:#f92672>=</span> Utf8               ()V
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span>9 <span style=color:#f92672>=</span> Utf8               Code
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>10 <span style=color:#f92672>=</span> Utf8               LineNumberTable
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>11 <span style=color:#f92672>=</span> Utf8               LocalVariableTable
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>12 <span style=color:#f92672>=</span> Utf8               <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>13 <span style=color:#f92672>=</span> Utf8               L方法区<span style=color:#f92672>/</span>Demo3;
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>14 <span style=color:#f92672>=</span> Utf8               main
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>15 <span style=color:#f92672>=</span> Utf8               (<span style=color:#f92672>[</span>Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String;)V
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>16 <span style=color:#f92672>=</span> Utf8               args
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>17 <span style=color:#f92672>=</span> Utf8               <span style=color:#f92672>[</span>Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String;
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>18 <span style=color:#f92672>=</span> Utf8               SourceFile
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>19 <span style=color:#f92672>=</span> Utf8               Demo3.<span style=color:#a6e22e>java</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>20 <span style=color:#f92672>=</span> NameAndType        <span style=color:#960050;background-color:#1e0010>#</span>7:<span style=color:#960050;background-color:#1e0010>#</span>8          <span style=color:#75715e>// &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>21 <span style=color:#f92672>=</span> Class              <span style=color:#960050;background-color:#1e0010>#</span>28            <span style=color:#75715e>// java/lang/System</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>22 <span style=color:#f92672>=</span> NameAndType        <span style=color:#960050;background-color:#1e0010>#</span>29:<span style=color:#960050;background-color:#1e0010>#</span>30        <span style=color:#75715e>// out:Ljava/io/PrintStream;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>23 <span style=color:#f92672>=</span> Utf8               Hello world
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>24 <span style=color:#f92672>=</span> Class              <span style=color:#960050;background-color:#1e0010>#</span>31            <span style=color:#75715e>// java/io/PrintStream</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>25 <span style=color:#f92672>=</span> NameAndType        <span style=color:#960050;background-color:#1e0010>#</span>32:<span style=color:#960050;background-color:#1e0010>#</span>33        <span style=color:#75715e>// println:(Ljava/lang/String;)V</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>26 <span style=color:#f92672>=</span> Utf8               方法区<span style=color:#f92672>/</span>Demo3
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>27 <span style=color:#f92672>=</span> Utf8               java<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>Object
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>28 <span style=color:#f92672>=</span> Utf8               java<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>System
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>29 <span style=color:#f92672>=</span> Utf8               out
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>30 <span style=color:#f92672>=</span> Utf8               Ljava<span style=color:#f92672>/</span>io<span style=color:#f92672>/</span>PrintStream;
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>31 <span style=color:#f92672>=</span> Utf8               java<span style=color:#f92672>/</span>io<span style=color:#f92672>/</span>PrintStream
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>32 <span style=color:#f92672>=</span> Utf8               println
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span>33 <span style=color:#f92672>=</span> Utf8               (Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String;)V
</span></span><span style=display:flex><span>                            
</span></span><span style=display:flex><span><span style=color:#75715e>// 类的方法定义</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> 方法区.<span style=color:#a6e22e>Demo3</span>();
</span></span><span style=display:flex><span>    descriptor: ()V
</span></span><span style=display:flex><span>    flags: (0x0001) ACC_PUBLIC
</span></span><span style=display:flex><span>    Code:
</span></span><span style=display:flex><span>      stack<span style=color:#f92672>=</span>1, locals<span style=color:#f92672>=</span>1, args_size<span style=color:#f92672>=</span>1
</span></span><span style=display:flex><span>         0: aload_0
</span></span><span style=display:flex><span>         1: invokespecial <span style=color:#960050;background-color:#1e0010>#</span>1                  <span style=color:#75715e>// Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span style=display:flex><span>         4: <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>      LineNumberTable:
</span></span><span style=display:flex><span>        line 6: 0
</span></span><span style=display:flex><span>      LocalVariableTable:
</span></span><span style=display:flex><span>        Start  Length  Slot  Name   Signature
</span></span><span style=display:flex><span>            0       5     0  <span style=color:#66d9ef>this</span>   L方法区<span style=color:#f92672>/</span>Demo3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span><span style=color:#f92672>[]</span>);
</span></span><span style=display:flex><span>    descriptor: (<span style=color:#f92672>[</span>Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String;)V
</span></span><span style=display:flex><span>    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
</span></span><span style=display:flex><span>    Code:
</span></span><span style=display:flex><span>      stack<span style=color:#f92672>=</span>2, locals<span style=color:#f92672>=</span>1, args_size<span style=color:#f92672>=</span>1
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 虚拟机指令</span>
</span></span><span style=display:flex><span>         0: getstatic     <span style=color:#960050;background-color:#1e0010>#</span>2                  <span style=color:#75715e>// Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span></span><span style=display:flex><span>         3: ldc           <span style=color:#960050;background-color:#1e0010>#</span>3                  <span style=color:#75715e>// String Hello world</span>
</span></span><span style=display:flex><span>         5: invokevirtual <span style=color:#960050;background-color:#1e0010>#</span>4                  <span style=color:#75715e>// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span></span><span style=display:flex><span>         8: <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>      LineNumberTable:
</span></span><span style=display:flex><span>        line 8: 0
</span></span><span style=display:flex><span>        line 9: 8
</span></span><span style=display:flex><span>      LocalVariableTable:
</span></span><span style=display:flex><span>        Start  Length  Slot  Name   Signature
</span></span><span style=display:flex><span>            0       9     0  args   <span style=color:#f92672>[</span>Ljava<span style=color:#f92672>/</span>lang<span style=color:#f92672>/</span>String;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>SourceFile: <span style=color:#e6db74>&#34;Demo3.java&#34;</span>
</span></span></code></pre></div><h5 id=串池stringtable的特性>串池(StringTable)的特性<a href=#串池stringtable的特性 class=hanchor arialabel=Anchor>&#8983;</a></h5><p>常量池中的字符串仅是符号,第一次用到的时候才回变成对象</p><p>利用串池的机制,来避免重复创建字符串对象</p><p>字符串变量拼接的原理是<code>StringBuilder</code>(1.8)</p><p>字符串常量拼接的原理是编译期优化</p><p>可以使用<code>intern</code>方法,主动将串池中的还没有的字符串对象放入串池</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        String s <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(<span style=color:#e6db74>&#34;a&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(<span style=color:#e6db74>&#34;b&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这是1.8的 讲字符串对象尝试放入到串池中,如果有不会放入,如果没有则会放入串池,会把串池中的对象返回</span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 1.8和1.6 不一样</span>
</span></span><span style=display:flex><span>        String intern <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>intern</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// true</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(intern<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;ab&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// true</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(s<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;ab&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=常量池和串池的区别>常量池和串池的区别<a href=#常量池和串池的区别 class=hanchor arialabel=Anchor>&#8983;</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// StringTable[&#34;a&#34;,&#34;b&#34;,&#34;ab&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反编译之后,常量池中的信息,都会被加载到运行时常量池中,这时都是常量池中的符号,还没有变成Java字符串对象</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 运行到s1这行代码的时候,就会把a符号变成a字符串对象,存入到stringtable[]中</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 用到才会创建字符串对象放到串池中,也就是懒加载</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String s1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;a&#34;</span>; <span style=color:#75715e>// 懒加载</span>
</span></span><span style=display:flex><span>        String s2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;b&#34;</span>;
</span></span><span style=display:flex><span>        String s3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ab&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 字符串相加的原理:new StringBuilder().append(s1).append(s2).toString()</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 上面s3的位置是在串池中,s4 是在堆内存中</span>
</span></span><span style=display:flex><span>        String s4 <span style=color:#f92672>=</span> s1 <span style=color:#f92672>+</span> s2;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// false</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(s3 <span style=color:#f92672>==</span> s4);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// javac在编译期间就确定为ab了,运行的时候直接去串池中查找</span>
</span></span><span style=display:flex><span>        String s5 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;a&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;b&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// true</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(s3 <span style=color:#f92672>==</span> s5);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>证明字符串加载的延迟特性</p><p><img src=https://image.runtimes.cc/202404051506157.png alt=image-20230823214436317></p><h5 id=stringtable的位置>StringTable的位置<a href=#stringtable的位置 class=hanchor arialabel=Anchor>&#8983;</a></h5><p>位置的移动,在1.6的时候要使用full gc才能被回收,1.8移动到堆内存了,minco gc 就可以回收</p><h5 id=stringtable的调优>StringTable的调优<a href=#stringtable的调优 class=hanchor arialabel=Anchor>&#8983;</a></h5><p>1.调整-XX:StringTableSize=桶的个数</p><p>2.考虑将字符串对象是否入池</p><p>比如有很多人的地址,都包含北京市这样的字符串,就应该考虑入池</p><h2 id=直接内存direct-memory>直接内存(Direct Memory)<a href=#直接内存direct-memory class=hanchor arialabel=Anchor>&#8983;</a></h2><p>常见于NIO(<code>ByteBuffer</code>)操作时,用户数据缓冲区</p><p>分配回收成本较高,读写性能高</p><p>不受JVM内存回收管理</p><p><img src=https://image.runtimes.cc/202404051508986.png alt=image-20230831150048574></p><h3 id=演示直接内存溢出>演示直接内存溢出<a href=#演示直接内存溢出 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> _100MB <span style=color:#f92672>=</span> 1024 <span style=color:#f92672>*</span> 1024 <span style=color:#f92672>*</span> 100;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ByteBuffer<span style=color:#f92672>&gt;</span> objects <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>                ByteBuffer allocate <span style=color:#f92672>=</span> ByteBuffer.<span style=color:#a6e22e>allocateDirect</span>(_100MB);
</span></span><span style=display:flex><span>                objects.<span style=color:#a6e22e>add</span>(allocate);
</span></span><span style=display:flex><span>                i<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(i);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Exception in thread <span style=color:#e6db74>&#34;main&#34;</span> java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>OutOfMemoryError</span>: Direct buffer memory
</span></span><span style=display:flex><span>	at java.<span style=color:#a6e22e>base</span><span style=color:#f92672>/</span>java.<span style=color:#a6e22e>nio</span>.<span style=color:#a6e22e>Bits</span>.<span style=color:#a6e22e>reserveMemory</span>(Bits.<span style=color:#a6e22e>java</span>:175)
</span></span><span style=display:flex><span>	at java.<span style=color:#a6e22e>base</span><span style=color:#f92672>/</span>java.<span style=color:#a6e22e>nio</span>.<span style=color:#a6e22e>DirectByteBuffer</span>.<span style=color:#f92672>&lt;</span>init<span style=color:#f92672>&gt;</span>(DirectByteBuffer.<span style=color:#a6e22e>java</span>:118)
</span></span><span style=display:flex><span>	at java.<span style=color:#a6e22e>base</span><span style=color:#f92672>/</span>java.<span style=color:#a6e22e>nio</span>.<span style=color:#a6e22e>ByteBuffer</span>.<span style=color:#a6e22e>allocateDirect</span>(ByteBuffer.<span style=color:#a6e22e>java</span>:317)
</span></span><span style=display:flex><span>	at 直接内存.<span style=color:#a6e22e>Demo</span>.<span style=color:#a6e22e>main</span>(Demo.<span style=color:#a6e22e>java</span>:18)
</span></span></code></pre></div><h3 id=释放原理>释放原理<a href=#释放原理 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>使用UnSafe对象完成了直接内存的分配回收,而且回收需要主动调用freeMemory方法</p><p>ByteBuffer的实现类内部,使用了Cleaner(虚引用)来检测ByteBuffer对象,一旦ByteBuffer对象被垃圾回收,就会由ReferenceHandler线程通过Cleaner方法调用freeMemory来释放直接内存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> _1GB <span style=color:#f92672>=</span> 1024 <span style=color:#f92672>*</span> 1024 <span style=color:#f92672>*</span> 1024;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>        ByteBuffer byteBuffer <span style=color:#f92672>=</span> ByteBuffer.<span style=color:#a6e22e>allocateDirect</span>(_1GB);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;分配完毕&#34;</span>); <span style=color:#75715e>// 看任务管理器,可以看到这个程序占用1G+</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;开始释放&#34;</span>);
</span></span><span style=display:flex><span>        byteBuffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>gc</span>();  <span style=color:#75715e>// 可以看到被会回收了,为什么会被回收呢</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 释放原理</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> _1GB <span style=color:#f92672>=</span> 1024 <span style=color:#f92672>*</span> 1024 <span style=color:#f92672>*</span> 1024;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, NoSuchFieldException, IllegalAccessException {
</span></span><span style=display:flex><span>        Unsafe unsafe <span style=color:#f92672>=</span> getUnsafe();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 分配内存</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// base 表示内存地址</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> base <span style=color:#f92672>=</span> unsafe.<span style=color:#a6e22e>allocateMemory</span>(_1GB);
</span></span><span style=display:flex><span>        unsafe.<span style=color:#a6e22e>setMemory</span>(base,_1GB,(<span style=color:#66d9ef>byte</span>)0);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 释放内存</span>
</span></span><span style=display:flex><span>        unsafe.<span style=color:#a6e22e>freeMemory</span>(base);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Unsafe <span style=color:#a6e22e>getUnsafe</span>() <span style=color:#66d9ef>throws</span> NoSuchFieldException, IllegalAccessException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field declaredField <span style=color:#f92672>=</span> Unsafe.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getDeclaredField</span>(<span style=color:#e6db74>&#34;theUnsafe&#34;</span>);
</span></span><span style=display:flex><span>        declaredField.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (Unsafe) declaredField.<span style=color:#a6e22e>get</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 源码</span>
</span></span><span style=display:flex><span>ByteBuffer.<span style=color:#a6e22e>allocateDirect</span>(_1GB);
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> ByteBuffer <span style=color:#a6e22e>allocateDirect</span>(<span style=color:#66d9ef>int</span> capacity) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectByteBuffer(capacity);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DirectByteBuffer(<span style=color:#66d9ef>int</span> cap) {                   <span style=color:#75715e>// package-private</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(<span style=color:#f92672>-</span>1, 0, cap, cap);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> pa <span style=color:#f92672>=</span> VM.<span style=color:#a6e22e>isDirectMemoryPageAligned</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ps <span style=color:#f92672>=</span> Bits.<span style=color:#a6e22e>pageSize</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> size <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>max</span>(1L, (<span style=color:#66d9ef>long</span>)cap <span style=color:#f92672>+</span> (pa <span style=color:#f92672>?</span> ps : 0));
</span></span><span style=display:flex><span>    Bits.<span style=color:#a6e22e>reserveMemory</span>(size, cap);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> base <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 分配内存</span>
</span></span><span style=display:flex><span>        base <span style=color:#f92672>=</span> UNSAFE.<span style=color:#a6e22e>allocateMemory</span>(size);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (OutOfMemoryError x) {
</span></span><span style=display:flex><span>        Bits.<span style=color:#a6e22e>unreserveMemory</span>(size, cap);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> x;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    UNSAFE.<span style=color:#a6e22e>setMemory</span>(base, size, (<span style=color:#66d9ef>byte</span>) 0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (pa <span style=color:#f92672>&amp;&amp;</span> (base <span style=color:#f92672>%</span> ps <span style=color:#f92672>!=</span> 0)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Round up to page boundary</span>
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> base <span style=color:#f92672>+</span> ps <span style=color:#f92672>-</span> (base <span style=color:#f92672>&amp;</span> (ps <span style=color:#f92672>-</span> 1));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> base;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// 当this被回收时,就会调用回调函数Deallocator</span>
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// 就是Java对象被回收，触发直接内存回收</span>
</span></span><span style=display:flex><span>    cleaner <span style=color:#f92672>=</span> Cleaner.<span style=color:#a6e22e>create</span>(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>new</span> Deallocator(base, size, cap));
</span></span><span style=display:flex><span>    att <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 继承了虚应用对象</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Cleaner</span> <span style=color:#66d9ef>extends</span> PhantomReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>{
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clean</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>remove(<span style=color:#66d9ef>this</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            thunk.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> Throwable x) {
</span></span><span style=display:flex><span>            AccessController.<span style=color:#a6e22e>doPrivileged</span>(<span style=color:#66d9ef>new</span> PrivilegedAction<span style=color:#f92672>&lt;&gt;</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>public</span> Void <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (System.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Cleaner terminated abnormally&#34;</span>, x)
</span></span><span style=display:flex><span>                                .<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>                        System.<span style=color:#a6e22e>exit</span>(1);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>                    }});
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 回调函数</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Deallocator</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>implements</span> Runnable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> address;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> size;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> capacity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Deallocator</span>(<span style=color:#66d9ef>long</span> address, <span style=color:#66d9ef>long</span> size, <span style=color:#66d9ef>int</span> capacity) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> (address <span style=color:#f92672>!=</span> 0);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>address</span> <span style=color:#f92672>=</span> address;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>=</span> size;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>capacity</span> <span style=color:#f92672>=</span> capacity;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (address <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Paranoia</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 释放直接内存</span>
</span></span><span style=display:flex><span>        UNSAFE.<span style=color:#a6e22e>freeMemory</span>(address);
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        Bits.<span style=color:#a6e22e>unreserveMemory</span>(size, capacity);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=垃圾回收机制>垃圾回收机制<a href=#垃圾回收机制 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=可达性分析法>可达性分析法<a href=#可达性分析法 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>如何判断对象是否可以回收</p><ol><li>引用计数法</li><li>可达性分析法,使用<a href=https://projects.eclipse.org/projects/tools.mat>Eclipse Memory Analyzer</a> ,沿着GC Root查找,找到就不能回收</li></ol><p>Eclipse Memory Analyzer的使用方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 使用mat 演示GC root
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ArrayList<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> list1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        list1.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;a&#34;</span>);
</span></span><span style=display:flex><span>        list1.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;b&#34;</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(1);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// jsp 获取到进程id</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// jmap -dump:format=b,live,file=1.bin 进程id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        list1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(2);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>read</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;end....&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>live 代表的意思是,执行dump文件的时候,先执行一次GC</p><p><img src=https://image.runtimes.cc/202404051508558.png alt=image-20230824141103802></p><p><img src=https://image.runtimes.cc/202404051508709.png alt=image-20230824141147149></p><p><img src=https://image.runtimes.cc/202404051509973.png alt=image-20230824141218556></p><p>大概有四类:</p><p>System Class</p><p>Native Stack,调用native方法要使用到的</p><p>Thread,活动线程,使用到的对象</p><p>Busy Monitor,各种锁</p><h3 id=四种引用>四种引用<a href=#四种引用 class=hanchor arialabel=Anchor>&#8983;</a></h3><p><img src=https://image.runtimes.cc/202404051509306.png alt=image-20230824141552451></p><p>强引用</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>强引用</td><td></td><td></td></tr><tr><td>软引用</td><td>有软引用引用该对象,只有在内存不足时才会被垃圾回收</td><td>可以配合引用队列来释放引用自身</td></tr><tr><td>弱引用</td><td>在GC时,不管内存是否充足都会被回收</td><td>可以配合引用队列来释放引用自身</td></tr><tr><td>需引用</td><td>主要分配ByteBuffer使用,被引用对象回收时,被引用对象回收时,会将虚引用入队,由Reference Handler线程调用虚引用相关方法释放直接内存</td><td>必须配合引用队列</td></tr><tr><td>终结器引用</td><td>无需手动编码,GC时,终结器引用入队,再由Finalizer线程通过终结器引用并调用finalize方法,第二次GC时,才能被回收</td><td></td></tr></tbody></table><h3 id=垃圾回收算法>垃圾回收算法<a href=#垃圾回收算法 class=hanchor arialabel=Anchor>&#8983;</a></h3><ul><li>标记清除</li><li>标记整理</li><li>复制</li></ul><h4 id=标记清除>标记清除<a href=#标记清除 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>原本的内存使用情况</p><p><img src=https://image.runtimes.cc/202404051509603.png alt=image-20230824143552505></p><p>标记</p><p><img src=https://image.runtimes.cc/202404051512492.png alt=image-20230824143616710></p><p>把要清楚的内存的开始地址放在列表你,等下次要分配内存的时候,直接在列表里找</p><p>优点:就是速度快</p><p>缺点:产生内存碎片</p><h4 id=标记整理>标记整理<a href=#标记整理 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>标记</p><p><img src=https://image.runtimes.cc/202404051512395.png alt=image-20230824143845073></p><p>整理</p><p><img src=https://image.runtimes.cc/202404051512099.png alt=image-20230824143905620></p><p>优点:不会产生碎片</p><p>缺点:速度慢</p><h4 id=复制算法>复制算法<a href=#复制算法 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>原来的内存使用</p><p><img src=https://image.runtimes.cc/202404051514508.png alt=image-20230824144146317></p><p>标记</p><p><img src=https://image.runtimes.cc/202404051514387.png alt=image-20230824144219705></p><p>复制</p><p><img src=https://image.runtimes.cc/202404051514593.png alt=image-20230824144234895></p><p>清理</p><p><img src=https://image.runtimes.cc/202404051515251.png alt=image-20230824144247178></p><p>交换from 和 to的位置</p><p><img src=https://image.runtimes.cc/202404051515286.png alt=image-20230824144305405></p><h3 id=分代回收>分代回收<a href=#分代回收 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>新生代: Minor GC
</span></span><span style=display:flex><span>	伊甸园
</span></span><span style=display:flex><span>	幸存区 from
</span></span><span style=display:flex><span>	幸存区 to
</span></span><span style=display:flex><span>老年代: Full GC 也会清理新生代
</span></span></code></pre></div><ul><li><p>对象首先分配在伊甸园区域</p></li><li><p>﻿新生代空间不足时，触发 minor ge，伊甸园和trom 存活的对象使用copy 复制到10中，存活的对象年龄加1并且交换 from to</p></li><li><p>﻿﻿minor se 会引1发 stop the wvorid，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</p></li><li><p>﻿当对象寿命超过國值时，会晋升至老年代，最大寿命是15 (4bit)</p></li><li><p>﻿当老年代空间不足，会先尝试触发 mninor ge，如果之后空间仍不足，那么触发 foll ge, sTw的时间更长</p></li></ul><table><thead><tr><th>含义</th><th>参数</th><th></th></tr></thead><tbody><tr><td>堆初始大小</td><td>Xms</td><td></td></tr><tr><td>堆最大大小</td><td>xmx 或 -Xx:MaxFeapSize=size</td><td></td></tr><tr><td>新生代大小</td><td>Xmn 或 （-XX:NewSize=size + -XX:MaxNewSize=size)</td><td></td></tr><tr><td>幸存区比例（动态）</td><td>Xx:InitialSurvivorRatio=ratio 和-XX:+UseAdaptiveSizePolicy</td><td></td></tr><tr><td>幸存区比例</td><td>XX:SurvivorRatio=ratio</td><td></td></tr><tr><td>晋升阈值</td><td>XX:MaxTenuringThreshold=threshold (threshold和具体的回收器有关)</td><td></td></tr><tr><td>晋升详情</td><td>XX: +PrintTenuringDistribution</td><td></td></tr><tr><td>GC详情</td><td>XX:+PrintGCDetails - verbose:go</td><td></td></tr><tr><td>FullGC 前 MinorGC</td><td>XX:+ScavengeBeforeFullGC</td><td></td></tr></tbody></table><h1 id=servlet>Servlet<a href=#servlet class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=搭建环境xml版本>搭建环境(XML版本)<a href=#搭建环境xml版本 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>下载,解压tomcat,运行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 进入目录</span>
</span></span><span style=display:flex><span>cd apache-tomcat-10.0.27/bin
</span></span><span style=display:flex><span><span style=color:#75715e># 运行</span>
</span></span><span style=display:flex><span>sh startup.sh
</span></span><span style=display:flex><span><span style=color:#75715e># 报错信息</span>
</span></span><span style=display:flex><span>The file is absent or does not have execute permission
</span></span><span style=display:flex><span>This file is needed to run this program
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 授权</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>777</span> apache-tomcat-10.0.27
</span></span><span style=display:flex><span><span style=color:#75715e># 再次运行</span>
</span></span><span style=display:flex><span>sh startup.sh
</span></span><span style=display:flex><span><span style=color:#75715e># 打印结果</span>
</span></span><span style=display:flex><span>Using CATALINA_BASE:   /Users/anthony/Downloads/apache-tomcat-10.0.27
</span></span><span style=display:flex><span>Using CATALINA_HOME:   /Users/anthony/Downloads/apache-tomcat-10.0.27
</span></span><span style=display:flex><span>Using CATALINA_TMPDIR: /Users/anthony/Downloads/apache-tomcat-10.0.27/temp
</span></span><span style=display:flex><span>Using JRE_HOME:        /Library/Java/JavaVirtualMachines/jdk-18.0.1.jdk/Contents/Home
</span></span><span style=display:flex><span>Using CLASSPATH:       /Users/anthony/Downloads/apache-tomcat-10.0.27/bin/bootstrap.jar:/Users/anthony/Downloads/apache-tomcat-10.0.27/bin/tomcat-juli.jar
</span></span><span style=display:flex><span>Using CATALINA_OPTS:
</span></span><span style=display:flex><span>Tomcat started.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 访问</span>
</span></span><span style=display:flex><span>http://localhost:8080
</span></span></code></pre></div><p>文件目录结构
<img src=https://image.runtimes.cc/202404051515409.png alt></p><p>导包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;project</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;modelVersion&gt;</span>4.0.0<span style=color:#f92672>&lt;/modelVersion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.example<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>servlet-xml<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>&lt;!-- 打war包 --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;packaging&gt;</span>war<span style=color:#f92672>&lt;/packaging&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.0-SNAPSHOT<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>servlet-xml Maven Webapp<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.tomcat<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>tomcat-servlet-api<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>10.0.4<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;finalName&gt;</span>servlet-xml<span style=color:#f92672>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/build&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/project&gt;</span>
</span></span></code></pre></div><p>因为是使用的tomcat10,所有导入的包不一样,如果是tomcat10之前的版本,导入的包好像是<code>java-serverlt-api</code></p><p>参考:<a href=https://taurusxin.com/tomcat10-issue/>https://taurusxin.com/tomcat10-issue/</a></p><p>代码</p><p>HelloWorld.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mmzcg.servlet;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入必需的 java 库</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.ServletException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletResponse;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.PrintWriter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 扩展 HttpServlet 类</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorld</span> <span style=color:#66d9ef>extends</span> HttpServlet {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() <span style=color:#66d9ef>throws</span> ServletException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行必需的初始化</span>
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;执行必需的初始化&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doGet</span>(HttpServletRequest request,
</span></span><span style=display:flex><span>                      HttpServletResponse response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ServletException, IOException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置响应内容类型</span>
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;text/html&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实际的逻辑是在这里</span>
</span></span><span style=display:flex><span>        PrintWriter out <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getWriter</span>();
</span></span><span style=display:flex><span>        out.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;&lt;h1&gt;&#34;</span> <span style=color:#f92672>+</span> message <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/h1&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 什么也不做</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;我就没见过销毁过&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Version.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mmzcg.servlet;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入必需的 java 库</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.ServletException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletResponse;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.PrintWriter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 扩展 HttpServlet 类</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Version</span> <span style=color:#66d9ef>extends</span> HttpServlet {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() <span style=color:#66d9ef>throws</span> ServletException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行必需的初始化</span>
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;执行必需的初始化&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doGet</span>(HttpServletRequest request,
</span></span><span style=display:flex><span>                      HttpServletResponse response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ServletException, IOException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置响应内容类型</span>
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;text/html&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实际的逻辑是在这里</span>
</span></span><span style=display:flex><span>        PrintWriter out <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getWriter</span>();
</span></span><span style=display:flex><span>        out.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;&lt;h1&gt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;返回的是版本号&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/h1&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 什么也不做</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;我就没见过销毁过&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>index.jsp</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 解决中文乱码</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;%</span><span style=color:#960050;background-color:#1e0010>@</span> page language<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;java&#34;</span> contentType<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/html; charset=UTF-8&#34;</span> pageEncoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>html<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>body<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>h2<span style=color:#f92672>&gt;</span>这是首页<span style=color:#f92672>&lt;/</span>h2<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>有两个url
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/hello&#34;</span><span style=color:#f92672>&gt;</span>hello<span style=color:#f92672>&lt;/</span>a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/version&#34;</span><span style=color:#f92672>&gt;</span>version<span style=color:#f92672>&lt;/</span>a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span>body<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span>html<span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>web.xml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>&lt;!</span>DOCTYPE web<span style=color:#f92672>-</span>app PUBLIC
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;http://java.sun.com/dtd/web-app_2_3.dtd&#34;</span> <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>web<span style=color:#f92672>-</span>app<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>display<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>Archetype Created Web Application<span style=color:#f92672>&lt;/</span>display<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>HelloWorld<span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>&gt;</span><span style=color:#a6e22e>com</span>.<span style=color:#a6e22e>mmzcg</span>.<span style=color:#a6e22e>servlet</span>.<span style=color:#a6e22e>HelloWorld</span><span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#a6e22e>servlet</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>Version<span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>&gt;</span><span style=color:#a6e22e>com</span>.<span style=color:#a6e22e>mmzcg</span>.<span style=color:#a6e22e>servlet</span>.<span style=color:#a6e22e>Version</span><span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&lt;/</span><span style=color:#a6e22e>servlet</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>mapping<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>HelloWorld<span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>url<span style=color:#f92672>-</span>pattern<span style=color:#f92672>&gt;/</span>hello<span style=color:#f92672>&lt;/</span>url<span style=color:#f92672>-</span>pattern<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>mapping<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>mapping<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>Version<span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>name<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>url<span style=color:#f92672>-</span>pattern<span style=color:#f92672>&gt;/</span>version<span style=color:#f92672>&lt;/</span>url<span style=color:#f92672>-</span>pattern<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/</span>servlet<span style=color:#f92672>-</span>mapping<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span>web<span style=color:#f92672>-</span>app<span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;project xmlns<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> xmlns:xsi<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>         xsi:schemaLocation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
</span></span><span style=display:flex><span>    &lt;groupId&gt;org.example&lt;/groupId&gt;
</span></span><span style=display:flex><span>    &lt;artifactId&gt;servlet-xml&lt;/artifactId&gt;
</span></span><span style=display:flex><span>    &lt;packaging&gt;war&lt;/packaging&gt;
</span></span><span style=display:flex><span>    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;name&gt;servlet-xml Maven Webapp&lt;/name&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;dependencies&gt;
</span></span><span style=display:flex><span>       &lt;dependency&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;tomcat-servlet-api&lt;/artifactId&gt;
</span></span><span style=display:flex><span>            &lt;version&gt;10.0.4&lt;/version&gt;
</span></span><span style=display:flex><span>        &lt;/dependency&gt;
</span></span><span style=display:flex><span>    &lt;/dependencies&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;build&gt;
</span></span><span style=display:flex><span>        &lt;finalName&gt;servlet-xml&lt;/finalName&gt;
</span></span><span style=display:flex><span>    &lt;/build&gt;
</span></span><span style=display:flex><span>&lt;/project&gt;
</span></span></code></pre></div><p>运行环境一:在IDEA上运行tomcat</p><p>添加tomcat模板</p><p><img src=https://image.runtimes.cc/202404051515728.png alt></p><p>配置tomcat_home</p><p><img src=https://image.runtimes.cc/202404051515905.png alt></p><p>配置包和路径</p><p><img src=https://image.runtimes.cc/202404051515430.png alt></p><p>运行环境一:在命令行运行tomcat</p><p>先停掉tomcat,复制war包到webapps目录里</p><p><img src=https://image.runtimes.cc/202404051515813.png alt></p><p>再启动tomcat,默认的访问地址就是:<code>http://localhost:8080/servlet-xml/</code></p><h2 id=搭建环境注解版本>搭建环境(注解版本)<a href=#搭建环境注解版本 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>前面的都不变,只是改下代码</p><p>web.xml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE web-app PUBLIC
</span></span></span><span style=display:flex><span><span style=color:#75715e> &#34;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e> &#34;http://java.sun.com/dtd/web-app_2_3.dtd&#34; &gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;web-app&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;display-name&gt;</span>Archetype Created Web Application<span style=color:#f92672>&lt;/display-name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/web-app&gt;</span>
</span></span></code></pre></div><p>index.jsp</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>h2</span>&gt;Hello World!&lt;/<span style=color:#f92672>h2</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><p>运行环境一:在命令行运行tomcat</p><p><img src=https://image.runtimes.cc/202404051515268.png alt></p><p>HelloWorld.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mmzcg.annotation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入必需的 java 库</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.ServletException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.annotation.WebServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletResponse;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.PrintWriter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 扩展 HttpServlet 类</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@WebServlet</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorld</span> <span style=color:#66d9ef>extends</span> HttpServlet {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() <span style=color:#66d9ef>throws</span> ServletException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行必需的初始化</span>
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;注解执行必需的初始化&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doGet</span>(HttpServletRequest request,
</span></span><span style=display:flex><span>                      HttpServletResponse response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ServletException, IOException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置响应内容类型</span>
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;text/html&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实际的逻辑是在这里</span>
</span></span><span style=display:flex><span>        PrintWriter out <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getWriter</span>();
</span></span><span style=display:flex><span>        out.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;&lt;h1&gt;&#34;</span> <span style=color:#f92672>+</span> message <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/h1&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 什么也不做</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;注解我就没见过销毁过&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Version.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mmzcg.annotation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入必需的 java 库</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.ServletException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.annotation.WebServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServlet;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jakarta.servlet.http.HttpServletResponse;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.PrintWriter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 扩展 HttpServlet 类</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@WebServlet</span>(<span style=color:#e6db74>&#34;/version&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Version</span> <span style=color:#66d9ef>extends</span> HttpServlet {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() <span style=color:#66d9ef>throws</span> ServletException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行必需的初始化</span>
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;执行必需的初始化&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doGet</span>(HttpServletRequest request,
</span></span><span style=display:flex><span>                      HttpServletResponse response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ServletException, IOException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置响应内容类型</span>
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;text/html&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实际的逻辑是在这里</span>
</span></span><span style=display:flex><span>        PrintWriter out <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getWriter</span>();
</span></span><span style=display:flex><span>        out.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;&lt;h1&gt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;注解返回的是版本号&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/h1&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 什么也不做</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;我就没见过销毁过&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=中文乱码>中文乱码<a href=#中文乱码 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=tomcat配置文件>Tomcat配置文件<a href=#tomcat配置文件 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>apache-tomcat-8.5.69\conf\server.xml 添加URIEncoding=&ldquo;UTF-8&rdquo; 属性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>&lt;</span>Connector port<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;8080&#34;</span> protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;HTTP/1.1&#34;</span>
</span></span><span style=display:flex><span>               connectionTimeout<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;20000&#34;</span>
</span></span><span style=display:flex><span>               redirectPort<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;8443&#34;</span> 
</span></span><span style=display:flex><span>               URIEncoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span></code></pre></div><h3 id=idea指定编码>Idea指定编码<a href=#idea指定编码 class=hanchor arialabel=Anchor>&#8983;</a></h3><p><img src=https://image.runtimes.cc/202404051515788.png alt></p><h3 id=jsp指定编码>Jsp指定编码<a href=#jsp指定编码 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>在jsp的html最先添加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>&lt;%</span><span style=color:#960050;background-color:#1e0010>@</span> <span style=color:#f92672>**</span>page<span style=color:#f92672>**</span> language<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;java&#34;</span> contentType<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/html; charset=UTF-8&#34;</span> pageEncoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>%&gt;</span>
</span></span></code></pre></div><h3 id=httpresponse指定编码>httpResponse指定编码<a href=#httpresponse指定编码 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 备注：该方法只对POST方式提交的数据有效，对GET方式提交的数据无效!</span>
</span></span><span style=display:flex><span>request.<span style=color:#a6e22e>setCharacterEncoding</span>(<span style=color:#e6db74>&#34;UTF-8&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//在响应中主动告诉浏览器使用UTF-8编码格式来接收数据</span>
</span></span><span style=display:flex><span>response.<span style=color:#a6e22e>setHeader</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/html;charset=UTF-8&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//可以使用封装类简写Content-Type，使用该方法则无需使用setCharacterEncoding</span>
</span></span><span style=display:flex><span>response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;text/html;charset=UTF-8&#34;</span>);
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://connorzhangyu.com/posts/idea/><span class=button__icon>←</span>
<span class=button__text>IDEA</span>
</a></span><span class="button next"><a href=https://connorzhangyu.com/posts/%E5%89%8D%E7%AB%AF/javascript/><span class=button__text>JavaScript</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>