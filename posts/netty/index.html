<!doctype html><html lang=zh><head><title>Netty :: Hello World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='Server
// 把 NettyServer 的创建交给 Spring 管理 @Component public class NettyServer { private Logger logger = LoggerFactory.getLogger(getClass()); @Value("${netty.port}") private Integer port; @Resource private NettyServerHandlerInitializer nettyServerHandlerInitializer; // boss 线程组，用于服务端接受客户端的连接 private EventLoopGroup bossGroup = new NioEventLoopGroup(); // worker 线程组，用于服务端接受客户端的数据读写 private EventLoopGroup workerGroup = new NioEventLoopGroup(); // Netty Server Channel private Channel channel; // 启动 Netty Server @PostConstruct public void start() throws InterruptedException { // 创建 ServerBootstrap 对象，用于 Netty Server 启动 ServerBootstrap bootstrap = new ServerBootstrap(); // 设置 ServerBootstrap 的各种属性 // 设置两个 EventLoopGroup 对象 bootstrap.group(bossGroup, workerGroup) // 指定 Channel 为服务端 NioServerSocketChannel .channel(NioServerSocketChannel.class) // 设置 Netty Server 的端口 .localAddress(new InetSocketAddress(port)) // 服务端 accept 队列的大小 .option(ChannelOption.SO_BACKLOG, 1024) // TCP Keepalive 机制，实现 TCP 层级的心跳保活功能 .childOption(ChannelOption.SO_KEEPALIVE, true) // 允许较小的数据包的发送，降低延迟 .childOption(ChannelOption.TCP_NODELAY, true) // 处理器 .childHandler(nettyServerHandlerInitializer); // 绑定端口，并同步等待成功，即启动服务端 ChannelFuture future = bootstrap.bind().sync(); if (future.isSuccess()) { channel = future.channel(); logger.info("[start][Netty Server 启动在 {} 端口]", port); } } // 关闭 Netty Server @PreDestroy public void shutdown() { // 关闭 Netty Server if (channel != null) { channel.close(); } // <3.2> 优雅关闭两个 EventLoopGroup 对象 bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully(); } } NettyServerHandlerInitializer
'><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=../../posts/netty/><link rel=stylesheet href=../../styles.css><link rel="shortcut icon" href=../../img/theme-colors/orange.png><link rel=apple-touch-icon href=../../img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Anthony"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="Netty"><meta property="og:description" content='Server
// 把 NettyServer 的创建交给 Spring 管理 @Component public class NettyServer { private Logger logger = LoggerFactory.getLogger(getClass()); @Value("${netty.port}") private Integer port; @Resource private NettyServerHandlerInitializer nettyServerHandlerInitializer; // boss 线程组，用于服务端接受客户端的连接 private EventLoopGroup bossGroup = new NioEventLoopGroup(); // worker 线程组，用于服务端接受客户端的数据读写 private EventLoopGroup workerGroup = new NioEventLoopGroup(); // Netty Server Channel private Channel channel; // 启动 Netty Server @PostConstruct public void start() throws InterruptedException { // 创建 ServerBootstrap 对象，用于 Netty Server 启动 ServerBootstrap bootstrap = new ServerBootstrap(); // 设置 ServerBootstrap 的各种属性 // 设置两个 EventLoopGroup 对象 bootstrap.group(bossGroup, workerGroup) // 指定 Channel 为服务端 NioServerSocketChannel .channel(NioServerSocketChannel.class) // 设置 Netty Server 的端口 .localAddress(new InetSocketAddress(port)) // 服务端 accept 队列的大小 .option(ChannelOption.SO_BACKLOG, 1024) // TCP Keepalive 机制，实现 TCP 层级的心跳保活功能 .childOption(ChannelOption.SO_KEEPALIVE, true) // 允许较小的数据包的发送，降低延迟 .childOption(ChannelOption.TCP_NODELAY, true) // 处理器 .childHandler(nettyServerHandlerInitializer); // 绑定端口，并同步等待成功，即启动服务端 ChannelFuture future = bootstrap.bind().sync(); if (future.isSuccess()) { channel = future.channel(); logger.info("[start][Netty Server 启动在 {} 端口]", port); } } // 关闭 Netty Server @PreDestroy public void shutdown() { // 关闭 Netty Server if (channel != null) { channel.close(); } // <3.2> 优雅关闭两个 EventLoopGroup 对象 bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully(); } } NettyServerHandlerInitializer
'><meta property="og:url" content="/posts/netty/"><meta property="og:site_name" content="Hello World"><meta property="og:image" content="https://image.runtimes.cc/202404051531898.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Java"><meta property="article:section" content="Netty"><meta property="article:published_time" content="2023-12-10 19:03:58 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=../../><div class=logo>康纳的记仇小本本</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=../../about>关于</a></li><li><a href=../../showcase>精选</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=../../about>关于</a></li><li><a href=../../showcase>精选</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=../../posts/netty/>Netty</a></h1><div class=post-meta><time class=post-date>2023-12-10</time><span class=post-author>Anthony</span></div><span class=post-tags>#<a href=../../tags/java/>Java</a>&nbsp;
#<a href=../../tags/spring/>Spring</a>&nbsp;
#<a href=../../tags/netty/>Netty</a>&nbsp;
</span><img src=https://image.runtimes.cc/202404051531898.png class=post-cover alt=" " title="Cover Image"><div class=post-content><div><p>Server</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 把 NettyServer 的创建交给 Spring 管理</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(getClass());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${netty.port}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer port;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Resource</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> NettyServerHandlerInitializer nettyServerHandlerInitializer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// boss 线程组，用于服务端接受客户端的连接</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> EventLoopGroup bossGroup <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// worker 线程组，用于服务端接受客户端的数据读写</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> EventLoopGroup workerGroup <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Netty Server Channel</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Channel channel;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动 Netty Server</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>() <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建 ServerBootstrap 对象，用于 Netty Server 启动</span>
</span></span><span style=display:flex><span>        ServerBootstrap bootstrap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerBootstrap();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置 ServerBootstrap 的各种属性</span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 设置两个 EventLoopGroup 对象</span>
</span></span><span style=display:flex><span>        bootstrap.<span style=color:#a6e22e>group</span>(bossGroup, workerGroup)
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// 指定 Channel 为服务端 NioServerSocketChannel</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>channel</span>(NioServerSocketChannel.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// 设置 Netty Server 的端口</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>localAddress</span>(<span style=color:#66d9ef>new</span> InetSocketAddress(port)) 
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// 服务端 accept 队列的大小</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>option</span>(ChannelOption.<span style=color:#a6e22e>SO_BACKLOG</span>, 1024) 
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// TCP Keepalive 机制，实现 TCP 层级的心跳保活功能</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>childOption</span>(ChannelOption.<span style=color:#a6e22e>SO_KEEPALIVE</span>, <span style=color:#66d9ef>true</span>) 
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// 允许较小的数据包的发送，降低延迟</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>childOption</span>(ChannelOption.<span style=color:#a6e22e>TCP_NODELAY</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>          			<span style=color:#75715e>// 处理器</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>childHandler</span>(nettyServerHandlerInitializer);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 绑定端口，并同步等待成功，即启动服务端</span>
</span></span><span style=display:flex><span>        ChannelFuture future <span style=color:#f92672>=</span> bootstrap.<span style=color:#a6e22e>bind</span>().<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (future.<span style=color:#a6e22e>isSuccess</span>()) {
</span></span><span style=display:flex><span>            channel <span style=color:#f92672>=</span> future.<span style=color:#a6e22e>channel</span>();
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;[start][Netty Server 启动在 {} 端口]&#34;</span>, port);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 关闭 Netty Server</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PreDestroy</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭 Netty Server</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (channel <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// &lt;3.2&gt; 优雅关闭两个 EventLoopGroup 对象</span>
</span></span><span style=display:flex><span>        bossGroup.<span style=color:#a6e22e>shutdownGracefully</span>();
</span></span><span style=display:flex><span>        workerGroup.<span style=color:#a6e22e>shutdownGracefully</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>NettyServerHandlerInitializer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyServerHandlerInitializer</span> <span style=color:#66d9ef>extends</span> ChannelInitializer<span style=color:#f92672>&lt;</span>Channel<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 心跳超时时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Integer READ_TIMEOUT_SECONDS <span style=color:#f92672>=</span> 3 <span style=color:#f92672>*</span> 60;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Resource</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> NettyServerHandler nettyServerHandler;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(Channel ch) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获得 Channel 对应的 ChannelPipeline</span>
</span></span><span style=display:flex><span>        ChannelPipeline channelPipeline <span style=color:#f92672>=</span> ch.<span style=color:#a6e22e>pipeline</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加一堆 NettyServerHandler 到 ChannelPipeline 中</span>
</span></span><span style=display:flex><span>        channelPipeline
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 空闲检测</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> ReadTimeoutHandler(READ_TIMEOUT_SECONDS, TimeUnit.<span style=color:#a6e22e>SECONDS</span>))
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 编码器</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> InvocationEncoder())
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 解码器</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> InvocationDecoder())
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 消息分发器</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>addLast</span>(messageDispatcher)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 服务端处理器</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>addLast</span>(nettyServerHandler)
</span></span><span style=display:flex><span>        ;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=模拟启动netty>模拟启动Netty<a href=#模拟启动netty class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ChannelFuture future <span style=color:#f92672>=</span> bootstrap.<span style=color:#a6e22e>bind</span>(port).<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Netty 代理服务器启动，监听端口：&#34;</span> <span style=color:#f92672>+</span> port);
</span></span><span style=display:flex><span>future.<span style=color:#a6e22e>channel</span>().<span style=color:#a6e22e>closeFuture</span>().<span style=color:#a6e22e>sync</span>(); <span style=color:#75715e>// 阻塞直到关闭</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>        RiceCooker cooker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RiceCooker();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 模拟 bootstrap.bind().sync()</span>
</span></span><span style=display:flex><span>        cooker.<span style=color:#a6e22e>start</span>();  <span style=color:#75715e>// 启动（阻塞直到准备好）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 模拟 future.channel().closeFuture().sync()</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                Thread.<span style=color:#a6e22e>sleep</span>(5000); <span style=color:#75715e>// 模拟5秒后煮好饭</span>
</span></span><span style=display:flex><span>                cooker.<span style=color:#a6e22e>close</span>();     <span style=color:#75715e>// 自动关闭</span>
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (InterruptedException ignored) {}
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cooker.<span style=color:#a6e22e>waitUntilClosed</span>(); <span style=color:#75715e>// 阻塞，直到关闭</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RiceCooker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isStarted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isClosed <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动电饭煲</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>() <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;启动电饭煲...&#34;</span>);
</span></span><span style=display:flex><span>        Thread.<span style=color:#a6e22e>sleep</span>(1000); <span style=color:#75715e>// 模拟准备时间</span>
</span></span><span style=display:flex><span>        isStarted <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;电饭煲开始煮饭！&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 等待“煮饭完成”</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>waitUntilClosed</span>() <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>isClosed) {
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(500); <span style=color:#75715e>// 等待状态变化</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;煮饭完成，电饭煲关闭。&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span>() {
</span></span><span style=display:flex><span>        isClosed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=粘包>粘包<a href=#粘包 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=模拟粘包问题>模拟粘包问题<a href=#模拟粘包问题 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        EventLoopGroup boss <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>        EventLoopGroup worker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ServerBootstrap b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerBootstrap();
</span></span><span style=display:flex><span>        b.<span style=color:#a6e22e>group</span>(boss, worker)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>channel</span>(NioServerSocketChannel.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>childHandler</span>(<span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(SocketChannel ch) {
</span></span><span style=display:flex><span>                        ChannelPipeline pipeline <span style=color:#f92672>=</span> ch.<span style=color:#a6e22e>pipeline</span>();
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 👇 没有拆包处理器，粘包将出现！</span>
</span></span><span style=display:flex><span>                        pipeline.<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> ServerHandler());
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        b.<span style=color:#a6e22e>bind</span>(8080).<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Server started on port 8080&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServerHandler</span> <span style=color:#66d9ef>extends</span> SimpleChannelInboundHandler<span style=color:#f92672>&lt;</span>ByteBuf<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead0</span>(ChannelHandlerContext ctx, ByteBuf msg) {
</span></span><span style=display:flex><span>        String received <span style=color:#f92672>=</span> msg.<span style=color:#a6e22e>toString</span>(CharsetUtil.<span style=color:#a6e22e>UTF_8</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;数据长度：&#34;</span> <span style=color:#f92672>+</span> msg.<span style=color:#a6e22e>readableBytes</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;原始数据: [&#34;</span> <span style=color:#f92672>+</span> received <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        EventLoopGroup group <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Bootstrap bootstrap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Bootstrap();
</span></span><span style=display:flex><span>        bootstrap.<span style=color:#a6e22e>group</span>(group)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>channel</span>(NioSocketChannel.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>handler</span>(<span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(SocketChannel ch) {
</span></span><span style=display:flex><span>                        ch.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> ChannelInboundHandlerAdapter() {
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelActive</span>(ChannelHandlerContext ctx) {
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// 连续发多条消息，粘包一定会出现</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 5; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                                    String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;msg&#34;</span> <span style=color:#f92672>+</span> i <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>;
</span></span><span style=display:flex><span>                                    ctx.<span style=color:#a6e22e>writeAndFlush</span>(Unpooled.<span style=color:#a6e22e>copiedBuffer</span>(msg, CharsetUtil.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span>                                }
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        });
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bootstrap.<span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, 8080).<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>服务端打印</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Server started on port <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>数据长度：25
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg0
</span></span><span style=display:flex><span>msg1
</span></span><span style=display:flex><span>msg2
</span></span><span style=display:flex><span>msg3
</span></span><span style=display:flex><span>msg4
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>这里错误情况,正常情况应该是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>原始数据:<span style=color:#f92672>[</span>msg0<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>原始数据:<span style=color:#f92672>[</span>msg1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>原始数据:<span style=color:#f92672>[</span>msg2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>.....
</span></span></code></pre></div><h3 id=方案1换行符或自定义分隔符>方案1:换行符或自定义分隔符<a href=#方案1换行符或自定义分隔符 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>在服务端配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 按 \n 拆</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> LineBasedFrameDecoder(1024); 
</span></span><span style=display:flex><span><span style=color:#75715e>// 按 &#34;--&#34; 拆</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> DelimiterBasedFrameDecoder(1024, Unpooled.<span style=color:#a6e22e>wrappedBuffer</span>(<span style=color:#e6db74>&#34;--&#34;</span>.<span style=color:#a6e22e>getBytes</span>())); 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        EventLoopGroup boss <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>        EventLoopGroup worker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ServerBootstrap b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerBootstrap();
</span></span><span style=display:flex><span>        b.<span style=color:#a6e22e>group</span>(boss, worker)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>channel</span>(NioServerSocketChannel.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>childHandler</span>(<span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(SocketChannel ch) {
</span></span><span style=display:flex><span>                        ChannelPipeline pipeline <span style=color:#f92672>=</span> ch.<span style=color:#a6e22e>pipeline</span>();
</span></span><span style=display:flex><span>                        pipeline.<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> LineBasedFrameDecoder(1024));
</span></span><span style=display:flex><span><span style=color:#75715e>//                        pipeline.addLast(new DelimiterBasedFrameDecoder(1024, Unpooled.wrappedBuffer(&#34;--&#34;.getBytes())));</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 👇 没有拆包处理器，粘包将出现！</span>
</span></span><span style=display:flex><span>                        pipeline.<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> ServerHandler());
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        b.<span style=color:#a6e22e>bind</span>(8080).<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Server started on port 8080&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServerHandler</span> <span style=color:#66d9ef>extends</span> SimpleChannelInboundHandler<span style=color:#f92672>&lt;</span>ByteBuf<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead0</span>(ChannelHandlerContext ctx, ByteBuf msg) {
</span></span><span style=display:flex><span>        String received <span style=color:#f92672>=</span> msg.<span style=color:#a6e22e>toString</span>(CharsetUtil.<span style=color:#a6e22e>UTF_8</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;数据长度：&#34;</span> <span style=color:#f92672>+</span> msg.<span style=color:#a6e22e>readableBytes</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;原始数据: [&#34;</span> <span style=color:#f92672>+</span> received <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>控制台打印,这是正常的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Server started on port <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>数据长度：4
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg0<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>数据长度：4
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>数据长度：4
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>数据长度：4
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg3<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>数据长度：4
</span></span><span style=display:flex><span>原始数据: <span style=color:#f92672>[</span>msg4<span style=color:#f92672>]</span>
</span></span></code></pre></div><h3 id=方案2固定长度>方案2:固定长度<a href=#方案2固定长度 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 客户端每条消息必须正好 8 字节，否则解析错。</span>
</span></span><span style=display:flex><span>pipeline.<span style=color:#a6e22e>addLast</span>(<span style=color:#66d9ef>new</span> FixedLengthFrameDecoder(8));
</span></span></code></pre></div><h3 id=方案三lengthfieldbasedframedecoder>方案三：LengthFieldBasedFrameDecoder<a href=#方案三lengthfieldbasedframedecoder class=hanchor arialabel=Anchor>&#8983;</a></h3></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=../../posts/tron/><span class=button__icon>←</span>
<span class=button__text>Tron</span>
</a></span><span class="button next"><a href=../../posts/kubernetes/><span class=button__text>Kubernetes</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=../../bundle.min.js></script></div></body></html>