<!doctype html><html lang=zh><head><title>ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹ :: Hello World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹ åœ¨ç°ä»£ç½‘ç«™æ¶æ„ä¸­ï¼ŒNginx å’Œ Cloudflare æ˜¯ä¸¤å¤§å…³é”®æŠ€æœ¯ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨æœåŠ¡å™¨ç«¯å’Œç½‘ç»œåŠ é€Ÿå±‚æä¾›å¼ºå¤§çš„æ”¯æŒã€‚æœ¬ç¯‡åšå®¢å°†å¸¦ä½ ä¸€æ­¥æ­¥é…ç½® Nginx ä¸ Cloudflare çš„é›†æˆï¼Œæ‰“é€ ä¸€ä¸ªé«˜æ€§èƒ½ä¸”å®‰å…¨çš„ç”Ÿäº§ç¯å¢ƒã€‚
ä¸€ã€ä¸ºä»€ä¹ˆé€‰æ‹© Nginx å’Œ Cloudflareï¼Ÿ Nginxï¼šä»¥å…¶è½»é‡çº§ã€é«˜å¹¶å‘æ€§èƒ½è‘—ç§°ï¼Œå¸¸ç”¨äºåå‘ä»£ç†ã€é™æ€æ–‡ä»¶æœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚ Cloudflareï¼šæä¾›å…è´¹ CDN åŠ é€Ÿã€DDoS é˜²æŠ¤ã€DNS æœåŠ¡ä»¥åŠ HTTPS åŠ å¯†æœåŠ¡ï¼Œæ˜¯å…¨çƒç«™ç‚¹ä¼˜åŒ–çš„ç†æƒ³é€‰æ‹©ã€‚ å½“äºŒè€…ç»“åˆæ—¶ï¼ŒCloudflare ä½äºç½‘ç»œå±‚ï¼Œè´Ÿè´£åŠ é€Ÿå’Œå®‰å…¨ï¼Œè€Œ Nginx ä½äºæœåŠ¡å™¨ç«¯ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œè¯·æ±‚åˆ†å‘ã€‚
äºŒã€Nginx çš„å®‰è£…ä¸åŸºæœ¬é…ç½® 1. å®‰è£… Nginx ä»¥ Ubuntu ä¸ºä¾‹ï¼š
sudo apt update sudo apt install nginx sudo systemctl start nginx sudo systemctl enable nginx å®‰è£…å®Œæˆåï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨ IPï¼Œç¡®è®¤æ˜¯å¦èƒ½çœ‹åˆ°é»˜è®¤æ¬¢è¿é¡µã€‚
2. é…ç½® Nginx åŸºæœ¬ç«™ç‚¹ åœ¨ /etc/nginx/conf.d/ ç›®å½•ä¸‹åˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶ï¼š
sudo nano /etc/nginx/conf.d/example.com.conf å†…å®¹å¦‚ä¸‹ï¼š
server { listen 80; server_name example.com www.example.com; root /var/www/example; index index.html index.htm; location / { try_files $uri $uri/ =404; } } ä¿å­˜æ–‡ä»¶åé‡è½½ Nginx é…ç½®ï¼š
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/><link rel=stylesheet href=https://connorzhangyu.com/styles.css><link rel="shortcut icon" href=https://connorzhangyu.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://connorzhangyu.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Connor"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹"><meta property="og:description" content="ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹ åœ¨ç°ä»£ç½‘ç«™æ¶æ„ä¸­ï¼ŒNginx å’Œ Cloudflare æ˜¯ä¸¤å¤§å…³é”®æŠ€æœ¯ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨æœåŠ¡å™¨ç«¯å’Œç½‘ç»œåŠ é€Ÿå±‚æä¾›å¼ºå¤§çš„æ”¯æŒã€‚æœ¬ç¯‡åšå®¢å°†å¸¦ä½ ä¸€æ­¥æ­¥é…ç½® Nginx ä¸ Cloudflare çš„é›†æˆï¼Œæ‰“é€ ä¸€ä¸ªé«˜æ€§èƒ½ä¸”å®‰å…¨çš„ç”Ÿäº§ç¯å¢ƒã€‚
ä¸€ã€ä¸ºä»€ä¹ˆé€‰æ‹© Nginx å’Œ Cloudflareï¼Ÿ Nginxï¼šä»¥å…¶è½»é‡çº§ã€é«˜å¹¶å‘æ€§èƒ½è‘—ç§°ï¼Œå¸¸ç”¨äºåå‘ä»£ç†ã€é™æ€æ–‡ä»¶æœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚ Cloudflareï¼šæä¾›å…è´¹ CDN åŠ é€Ÿã€DDoS é˜²æŠ¤ã€DNS æœåŠ¡ä»¥åŠ HTTPS åŠ å¯†æœåŠ¡ï¼Œæ˜¯å…¨çƒç«™ç‚¹ä¼˜åŒ–çš„ç†æƒ³é€‰æ‹©ã€‚ å½“äºŒè€…ç»“åˆæ—¶ï¼ŒCloudflare ä½äºç½‘ç»œå±‚ï¼Œè´Ÿè´£åŠ é€Ÿå’Œå®‰å…¨ï¼Œè€Œ Nginx ä½äºæœåŠ¡å™¨ç«¯ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œè¯·æ±‚åˆ†å‘ã€‚
äºŒã€Nginx çš„å®‰è£…ä¸åŸºæœ¬é…ç½® 1. å®‰è£… Nginx ä»¥ Ubuntu ä¸ºä¾‹ï¼š
sudo apt update sudo apt install nginx sudo systemctl start nginx sudo systemctl enable nginx å®‰è£…å®Œæˆåï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨ IPï¼Œç¡®è®¤æ˜¯å¦èƒ½çœ‹åˆ°é»˜è®¤æ¬¢è¿é¡µã€‚
2. é…ç½® Nginx åŸºæœ¬ç«™ç‚¹ åœ¨ /etc/nginx/conf.d/ ç›®å½•ä¸‹åˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶ï¼š
sudo nano /etc/nginx/conf.d/example.com.conf å†…å®¹å¦‚ä¸‹ï¼š
server { listen 80; server_name example.com www.example.com; root /var/www/example; index index.html index.htm; location / { try_files $uri $uri/ =404; } } ä¿å­˜æ–‡ä»¶åé‡è½½ Nginx é…ç½®ï¼š
"><meta property="og:url" content="https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/"><meta property="og:site_name" content="Hello World"><meta property="og:image" content="https://connorzhangyu.com/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-12-07 18:13:27 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>åº·çº³çš„è®°ä»‡å°æœ¬æœ¬</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/about>å…³äº</a></li><li><a href=/showcase>ç²¾é€‰</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>å…³äº</a></li><li><a href=/showcase>ç²¾é€‰</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/>ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹</a></h1><div class=post-meta><time class=post-date>2024-12-07</time><span class=post-author>Connor</span></div><div class=post-content><div><h1 id=ä½¿ç”¨-cloudflare-å’Œ-nginx-æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹>ä½¿ç”¨ Cloudflare å’Œ Nginx æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹<a href=#ä½¿ç”¨-cloudflare-å’Œ-nginx-æ„å»ºé«˜æ€§èƒ½å®‰å…¨ç«™ç‚¹ class=hanchor arialabel=Anchor>&#8983;</a></h1><p>åœ¨ç°ä»£ç½‘ç«™æ¶æ„ä¸­ï¼Œ<strong>Nginx</strong> å’Œ <strong>Cloudflare</strong> æ˜¯ä¸¤å¤§å…³é”®æŠ€æœ¯ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨æœåŠ¡å™¨ç«¯å’Œç½‘ç»œåŠ é€Ÿå±‚æä¾›å¼ºå¤§çš„æ”¯æŒã€‚æœ¬ç¯‡åšå®¢å°†å¸¦ä½ ä¸€æ­¥æ­¥é…ç½® Nginx ä¸ Cloudflare çš„é›†æˆï¼Œæ‰“é€ ä¸€ä¸ªé«˜æ€§èƒ½ä¸”å®‰å…¨çš„ç”Ÿäº§ç¯å¢ƒã€‚</p><hr><h2 id=ä¸€ä¸ºä»€ä¹ˆé€‰æ‹©-nginx-å’Œ-cloudflare>ä¸€ã€ä¸ºä»€ä¹ˆé€‰æ‹© Nginx å’Œ Cloudflareï¼Ÿ<a href=#ä¸€ä¸ºä»€ä¹ˆé€‰æ‹©-nginx-å’Œ-cloudflare class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><strong>Nginx</strong>ï¼šä»¥å…¶è½»é‡çº§ã€é«˜å¹¶å‘æ€§èƒ½è‘—ç§°ï¼Œå¸¸ç”¨äºåå‘ä»£ç†ã€é™æ€æ–‡ä»¶æœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚</li><li><strong>Cloudflare</strong>ï¼šæä¾›å…è´¹ CDN åŠ é€Ÿã€DDoS é˜²æŠ¤ã€DNS æœåŠ¡ä»¥åŠ HTTPS åŠ å¯†æœåŠ¡ï¼Œæ˜¯å…¨çƒç«™ç‚¹ä¼˜åŒ–çš„ç†æƒ³é€‰æ‹©ã€‚</li></ul><p>å½“äºŒè€…ç»“åˆæ—¶ï¼ŒCloudflare ä½äºç½‘ç»œå±‚ï¼Œè´Ÿè´£åŠ é€Ÿå’Œå®‰å…¨ï¼Œè€Œ Nginx ä½äºæœåŠ¡å™¨ç«¯ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œè¯·æ±‚åˆ†å‘ã€‚</p><hr><h2 id=äºŒnginx-çš„å®‰è£…ä¸åŸºæœ¬é…ç½®>äºŒã€Nginx çš„å®‰è£…ä¸åŸºæœ¬é…ç½®<a href=#äºŒnginx-çš„å®‰è£…ä¸åŸºæœ¬é…ç½® class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-å®‰è£…-nginx>1. å®‰è£… Nginx<a href=#1-å®‰è£…-nginx class=hanchor arialabel=Anchor>&#8983;</a></h3><p>ä»¥ Ubuntu ä¸ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install nginx
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span><span style=display:flex><span>sudo systemctl enable nginx
</span></span></code></pre></div><p>å®‰è£…å®Œæˆåï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨ IPï¼Œç¡®è®¤æ˜¯å¦èƒ½çœ‹åˆ°é»˜è®¤æ¬¢è¿é¡µã€‚</p><h3 id=2-é…ç½®-nginx-åŸºæœ¬ç«™ç‚¹>2. é…ç½® Nginx åŸºæœ¬ç«™ç‚¹<a href=#2-é…ç½®-nginx-åŸºæœ¬ç«™ç‚¹ class=hanchor arialabel=Anchor>&#8983;</a></h3><p>åœ¨ <code>/etc/nginx/conf.d/</code> ç›®å½•ä¸‹åˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/nginx/conf.d/example.com.conf
</span></span></code></pre></div><p>å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span> <span style=color:#e6db74>index.htm</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¿å­˜æ–‡ä»¶åé‡è½½ Nginx é…ç½®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nginx -t
</span></span><span style=display:flex><span>sudo systemctl reload nginx
</span></span></code></pre></div><hr><h2 id=ä¸‰cloudflare-çš„é…ç½®ä¸ä¼˜åŒ–>ä¸‰ã€Cloudflare çš„é…ç½®ä¸ä¼˜åŒ–<a href=#ä¸‰cloudflare-çš„é…ç½®ä¸ä¼˜åŒ– class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-å°†åŸŸåæ¥å…¥-cloudflare>1. å°†åŸŸåæ¥å…¥ Cloudflare<a href=#1-å°†åŸŸåæ¥å…¥-cloudflare class=hanchor arialabel=Anchor>&#8983;</a></h3><ol><li>æ³¨å†Œå¹¶ç™»å½• Cloudflareã€‚</li><li>æ·»åŠ ä½ çš„åŸŸåã€‚</li><li>ä¿®æ”¹åŸŸå DNS åˆ° Cloudflare æä¾›çš„è§£ææœåŠ¡å™¨ã€‚</li><li>å¯ç”¨ä»£ç†ï¼ˆæ©™è‰²å°äº‘ï¼‰ï¼ŒCloudflare å¼€å§‹åŠ é€Ÿä½ çš„åŸŸåã€‚</li></ol><h3 id=2-é…ç½®-ssl-æ¨¡å¼>2. é…ç½® SSL æ¨¡å¼<a href=#2-é…ç½®-ssl-æ¨¡å¼ class=hanchor arialabel=Anchor>&#8983;</a></h3><p>åœ¨ Cloudflare é¢æ¿ä¸­ï¼Œå‰å¾€ <strong>SSL/TLS > Overview</strong>ï¼Œé€‰æ‹©é€‚åˆä½ çš„æ¨¡å¼ï¼š</p><ul><li><strong>Flexible</strong>ï¼šä»… Cloudflare å’Œå®¢æˆ·ç«¯ä¹‹é—´ä½¿ç”¨ HTTPSï¼ˆä¸æ¨èï¼‰ã€‚</li><li><strong>Full</strong>ï¼šCloudflare å’Œ Nginx ä¹‹é—´ä½¿ç”¨ HTTPSï¼Œä½†æ— éœ€æœ‰æ•ˆè¯ä¹¦ã€‚</li><li><strong>Full (Strict)</strong>ï¼šæœ€å®‰å…¨æ¨¡å¼ï¼Œè¦æ±‚ Nginx æä¾›æœ‰æ•ˆçš„ SSL è¯ä¹¦ã€‚</li></ul><hr><h2 id=å››nginx-ä¸-cloudflare-çš„é›†æˆé…ç½®>å››ã€Nginx ä¸ Cloudflare çš„é›†æˆé…ç½®<a href=#å››nginx-ä¸-cloudflare-çš„é›†æˆé…ç½® class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-è·å–çœŸå®å®¢æˆ·ç«¯-ip>1. è·å–çœŸå®å®¢æˆ·ç«¯ IP<a href=#1-è·å–çœŸå®å®¢æˆ·ç«¯-ip class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Cloudflare ä»£ç†åï¼ŒNginx é»˜è®¤ä¼šè®°å½• Cloudflare çš„æœåŠ¡å™¨ IPã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ Nginx çš„ <code>http</code> å—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 103.21.244.0<span style=color:#e6db74>/22</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 104.16.0.0<span style=color:#e6db74>/12</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 108.162.192.0<span style=color:#e6db74>/18</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># æ›´å¤š IP è¯·å‚è€ƒ Cloudflare æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>real_ip_header</span> <span style=color:#e6db74>CF-Connecting-IP</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-é…ç½®-https-æ”¯æŒ>2. é…ç½® HTTPS æ”¯æŒ<a href=#2-é…ç½®-https-æ”¯æŒ class=hanchor arialabel=Anchor>&#8983;</a></h3><p>å¦‚æœé€‰æ‹©äº† <strong>Full (Strict)</strong> æ¨¡å¼ï¼ŒNginx å¿…é¡»é…ç½® SSLï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/ssl/certs/example.com.crt</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/ssl/private/example.com.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œä¸ºæå‡å®‰å…¨æ€§ï¼Œå»ºè®®å¯ç”¨ HSTSï¼ˆä¸¥æ ¼ä¼ è¾“å®‰å…¨ç­–ç•¥ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>Strict-Transport-Security</span> <span style=color:#e6db74>&#34;max-age=31536000</span>; <span style=color:#66d9ef>includeSubDomains&#34;</span> <span style=color:#e6db74>always</span>;
</span></span></code></pre></div><h3 id=3-é…ç½®ç¼“å­˜ä¸å‹ç¼©>3. é…ç½®ç¼“å­˜ä¸å‹ç¼©<a href=#3-é…ç½®ç¼“å­˜ä¸å‹ç¼© class=hanchor arialabel=Anchor>&#8983;</a></h3><p>å¯ç”¨ç¼“å­˜å¤´ï¼Œä¼˜åŒ–é™æ€èµ„æºç¼“å­˜ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Cache-Control</span> <span style=color:#e6db74>&#34;public,</span> <span style=color:#e6db74>max-age=3600&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>expires</span> <span style=color:#e6db74>1h</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯ç”¨ Gzip å‹ç¼©ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip_types</span> <span style=color:#e6db74>text/plain</span> <span style=color:#e6db74>application/json</span> <span style=color:#e6db74>application/javascript</span> <span style=color:#e6db74>text/css</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-ä»£ç†-websocket-å’Œ-api>4. ä»£ç† WebSocket å’Œ API<a href=#4-ä»£ç†-websocket-å’Œ-api class=hanchor arialabel=Anchor>&#8983;</a></h3><p>å¦‚æœæœ‰ WebSocket æˆ– API åç«¯ï¼Œç¡®ä¿ä»£ç†æ­£ç¡®è½¬å‘è¯·æ±‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/ws/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Upgrade</span> $http_upgrade;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Connection</span> <span style=color:#e6db74>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/api/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:8081</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=äº”ç”Ÿäº§ç¯å¢ƒä¸­çš„å®‰å…¨ä¸ä¼˜åŒ–>äº”ã€ç”Ÿäº§ç¯å¢ƒä¸­çš„å®‰å…¨ä¸ä¼˜åŒ–<a href=#äº”ç”Ÿäº§ç¯å¢ƒä¸­çš„å®‰å…¨ä¸ä¼˜åŒ– class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-é˜²ç«å¢™è§„åˆ™>1. é˜²ç«å¢™è§„åˆ™<a href=#1-é˜²ç«å¢™è§„åˆ™ class=hanchor arialabel=Anchor>&#8983;</a></h3><p>ä»…å…è®¸ Cloudflare çš„ IP è®¿é—®ä½ çš„æœåŠ¡å™¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ufw allow proto tcp from 103.21.244.0/22 to any port <span style=color:#ae81ff>443</span>
</span></span></code></pre></div><h3 id=2-æ—¥å¿—ç®¡ç†>2. æ—¥å¿—ç®¡ç†<a href=#2-æ—¥å¿—ç®¡ç† class=hanchor arialabel=Anchor>&#8983;</a></h3><p>å¯ç”¨è¯¦ç»†æ—¥å¿—ä¾¿äºæ’æŸ¥é—®é¢˜ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>access_log</span> <span style=color:#e6db74>/var/log/nginx/access.log</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>error_log</span> <span style=color:#e6db74>/var/log/nginx/error.log</span>;
</span></span></code></pre></div><h3 id=3-ç›‘æ§æ€§èƒ½>3. ç›‘æ§æ€§èƒ½<a href=#3-ç›‘æ§æ€§èƒ½ class=hanchor arialabel=Anchor>&#8983;</a></h3><p>ä½¿ç”¨å·¥å…·å¦‚ <code>htop</code> å’Œ <code>ngxtop</code> å®æ—¶ç›‘æ§ Nginx çš„æ€§èƒ½ã€‚</p><h3 id=4-é…ç½®-brotli-å‹ç¼©>4. é…ç½® Brotli å‹ç¼©<a href=#4-é…ç½®-brotli-å‹ç¼© class=hanchor arialabel=Anchor>&#8983;</a></h3><p>å¦‚æœ Cloudflare å¯ç”¨äº† Brotliï¼ŒNginx ä¹Ÿå¯æ”¯æŒï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>brotli</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>brotli_types</span> <span style=color:#e6db74>text/plain</span> <span style=color:#e6db74>application/json</span> <span style=color:#e6db74>application/javascript</span> <span style=color:#e6db74>text/css</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=å…­æ€»ç»“>å…­ã€æ€»ç»“<a href=#å…­æ€»ç»“ class=hanchor arialabel=Anchor>&#8983;</a></h2><p>é€šè¿‡å°† Cloudflare ä¸ Nginx é›†æˆï¼Œä½ å¯ä»¥å¤§å¹…æå‡ç«™ç‚¹çš„æ€§èƒ½ä¸å®‰å…¨æ€§ã€‚Cloudflare æä¾›äº†å¼ºå¤§çš„ç½‘ç»œå±‚åŠ é€Ÿå’Œé˜²æŠ¤ï¼ŒNginx åˆ™è´Ÿè´£é«˜æ•ˆå¤„ç†è¯·æ±‚å’Œä¸šåŠ¡é€»è¾‘ã€‚</p><p>æ— è®ºæ˜¯ä¸ªäººåšå®¢è¿˜æ˜¯ä¼ä¸šç«™ç‚¹ï¼Œè¿™ç§æ¶æ„éƒ½æ˜¯ç°ä»£ Web å¼€å‘çš„æœ€ä½³é€‰æ‹©ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼ ğŸ˜Š</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-nginx-+-cloudflare-+-docker-%E9%83%A8%E7%BD%B2-java-%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><span class=button__icon>â†</span>
<span class=button__text>ä½¿ç”¨ Nginx + Cloudflare + Docker éƒ¨ç½² Java æœåŠ¡çš„æœ€ä½³å®è·µ</span>
</a></span><span class="button next"><a href=https://connorzhangyu.com/posts/%E5%A6%82%E4%BD%95%E8%A7%84%E5%88%92-aws-%E5%AD%A6%E4%B9%A0%E4%B8%8E%E8%AE%A4%E8%AF%81%E8%B7%AF%E5%BE%84%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%9E%B6%E6%9E%84%E5%B8%88/><span class=button__text>å¦‚ä½•è§„åˆ’ AWS å­¦ä¹ ä¸è®¤è¯è·¯å¾„ï¼šä»å…¥é—¨åˆ°æ¶æ„å¸ˆ</span>
<span class=button__icon>â†’</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>