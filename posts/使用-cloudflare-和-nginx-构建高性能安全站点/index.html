<!doctype html><html lang=zh><head><title>使用 Cloudflare 和 Nginx 构建高性能安全站点 :: Hello World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="使用 Cloudflare 和 Nginx 构建高性能安全站点 在现代网站架构中，Nginx 和 Cloudflare 是两大关键技术，它们分别在服务器端和网络加速层提供强大的支持。本篇博客将带你一步步配置 Nginx 与 Cloudflare 的集成，打造一个高性能且安全的生产环境。
一、为什么选择 Nginx 和 Cloudflare？ Nginx：以其轻量级、高并发性能著称，常用于反向代理、静态文件服务和负载均衡。 Cloudflare：提供免费 CDN 加速、DDoS 防护、DNS 服务以及 HTTPS 加密服务，是全球站点优化的理想选择。 当二者结合时，Cloudflare 位于网络层，负责加速和安全，而 Nginx 位于服务器端，负责处理业务逻辑和请求分发。
二、Nginx 的安装与基本配置 1. 安装 Nginx 以 Ubuntu 为例：
sudo apt update sudo apt install nginx sudo systemctl start nginx sudo systemctl enable nginx 安装完成后，通过浏览器访问服务器 IP，确认是否能看到默认欢迎页。
2. 配置 Nginx 基本站点 在 /etc/nginx/conf.d/ 目录下创建站点配置文件：
sudo nano /etc/nginx/conf.d/example.com.conf 内容如下：
server { listen 80; server_name example.com www.example.com; root /var/www/example; index index.html index.htm; location / { try_files $uri $uri/ =404; } } 保存文件后重载 Nginx 配置：
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/><link rel=stylesheet href=https://connorzhangyu.com/styles.css><link rel="shortcut icon" href=https://connorzhangyu.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://connorzhangyu.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Connor"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="使用 Cloudflare 和 Nginx 构建高性能安全站点"><meta property="og:description" content="使用 Cloudflare 和 Nginx 构建高性能安全站点 在现代网站架构中，Nginx 和 Cloudflare 是两大关键技术，它们分别在服务器端和网络加速层提供强大的支持。本篇博客将带你一步步配置 Nginx 与 Cloudflare 的集成，打造一个高性能且安全的生产环境。
一、为什么选择 Nginx 和 Cloudflare？ Nginx：以其轻量级、高并发性能著称，常用于反向代理、静态文件服务和负载均衡。 Cloudflare：提供免费 CDN 加速、DDoS 防护、DNS 服务以及 HTTPS 加密服务，是全球站点优化的理想选择。 当二者结合时，Cloudflare 位于网络层，负责加速和安全，而 Nginx 位于服务器端，负责处理业务逻辑和请求分发。
二、Nginx 的安装与基本配置 1. 安装 Nginx 以 Ubuntu 为例：
sudo apt update sudo apt install nginx sudo systemctl start nginx sudo systemctl enable nginx 安装完成后，通过浏览器访问服务器 IP，确认是否能看到默认欢迎页。
2. 配置 Nginx 基本站点 在 /etc/nginx/conf.d/ 目录下创建站点配置文件：
sudo nano /etc/nginx/conf.d/example.com.conf 内容如下：
server { listen 80; server_name example.com www.example.com; root /var/www/example; index index.html index.htm; location / { try_files $uri $uri/ =404; } } 保存文件后重载 Nginx 配置：
"><meta property="og:url" content="https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/"><meta property="og:site_name" content="Hello World"><meta property="og:image" content="https://connorzhangyu.com/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-12-07 18:13:27 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>康纳的记仇小本本</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>关于</a></li><li><a href=/showcase>精选</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-cloudflare-%E5%92%8C-nginx-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9/>使用 Cloudflare 和 Nginx 构建高性能安全站点</a></h1><div class=post-meta><time class=post-date>2024-12-07</time><span class=post-author>Connor</span></div><div class=post-content><div><h1 id=使用-cloudflare-和-nginx-构建高性能安全站点>使用 Cloudflare 和 Nginx 构建高性能安全站点<a href=#使用-cloudflare-和-nginx-构建高性能安全站点 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>在现代网站架构中，<strong>Nginx</strong> 和 <strong>Cloudflare</strong> 是两大关键技术，它们分别在服务器端和网络加速层提供强大的支持。本篇博客将带你一步步配置 Nginx 与 Cloudflare 的集成，打造一个高性能且安全的生产环境。</p><hr><h2 id=一为什么选择-nginx-和-cloudflare>一、为什么选择 Nginx 和 Cloudflare？<a href=#一为什么选择-nginx-和-cloudflare class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><strong>Nginx</strong>：以其轻量级、高并发性能著称，常用于反向代理、静态文件服务和负载均衡。</li><li><strong>Cloudflare</strong>：提供免费 CDN 加速、DDoS 防护、DNS 服务以及 HTTPS 加密服务，是全球站点优化的理想选择。</li></ul><p>当二者结合时，Cloudflare 位于网络层，负责加速和安全，而 Nginx 位于服务器端，负责处理业务逻辑和请求分发。</p><hr><h2 id=二nginx-的安装与基本配置>二、Nginx 的安装与基本配置<a href=#二nginx-的安装与基本配置 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-安装-nginx>1. 安装 Nginx<a href=#1-安装-nginx class=hanchor arialabel=Anchor>&#8983;</a></h3><p>以 Ubuntu 为例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install nginx
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span><span style=display:flex><span>sudo systemctl enable nginx
</span></span></code></pre></div><p>安装完成后，通过浏览器访问服务器 IP，确认是否能看到默认欢迎页。</p><h3 id=2-配置-nginx-基本站点>2. 配置 Nginx 基本站点<a href=#2-配置-nginx-基本站点 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>在 <code>/etc/nginx/conf.d/</code> 目录下创建站点配置文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/nginx/conf.d/example.com.conf
</span></span></code></pre></div><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span> <span style=color:#e6db74>index.htm</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>保存文件后重载 Nginx 配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nginx -t
</span></span><span style=display:flex><span>sudo systemctl reload nginx
</span></span></code></pre></div><hr><h2 id=三cloudflare-的配置与优化>三、Cloudflare 的配置与优化<a href=#三cloudflare-的配置与优化 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-将域名接入-cloudflare>1. 将域名接入 Cloudflare<a href=#1-将域名接入-cloudflare class=hanchor arialabel=Anchor>&#8983;</a></h3><ol><li>注册并登录 Cloudflare。</li><li>添加你的域名。</li><li>修改域名 DNS 到 Cloudflare 提供的解析服务器。</li><li>启用代理（橙色小云），Cloudflare 开始加速你的域名。</li></ol><h3 id=2-配置-ssl-模式>2. 配置 SSL 模式<a href=#2-配置-ssl-模式 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>在 Cloudflare 面板中，前往 <strong>SSL/TLS > Overview</strong>，选择适合你的模式：</p><ul><li><strong>Flexible</strong>：仅 Cloudflare 和客户端之间使用 HTTPS（不推荐）。</li><li><strong>Full</strong>：Cloudflare 和 Nginx 之间使用 HTTPS，但无需有效证书。</li><li><strong>Full (Strict)</strong>：最安全模式，要求 Nginx 提供有效的 SSL 证书。</li></ul><hr><h2 id=四nginx-与-cloudflare-的集成配置>四、Nginx 与 Cloudflare 的集成配置<a href=#四nginx-与-cloudflare-的集成配置 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-获取真实客户端-ip>1. 获取真实客户端 IP<a href=#1-获取真实客户端-ip class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Cloudflare 代理后，Nginx 默认会记录 Cloudflare 的服务器 IP。为解决这个问题，在 Nginx 的 <code>http</code> 块中添加以下配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 103.21.244.0<span style=color:#e6db74>/22</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 104.16.0.0<span style=color:#e6db74>/12</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>set_real_ip_from</span> 108.162.192.0<span style=color:#e6db74>/18</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># 更多 IP 请参考 Cloudflare 文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>real_ip_header</span> <span style=color:#e6db74>CF-Connecting-IP</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-配置-https-支持>2. 配置 HTTPS 支持<a href=#2-配置-https-支持 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>如果选择了 <strong>Full (Strict)</strong> 模式，Nginx 必须配置 SSL：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/ssl/certs/example.com.crt</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/ssl/private/example.com.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，为提升安全性，建议启用 HSTS（严格传输安全策略）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>Strict-Transport-Security</span> <span style=color:#e6db74>&#34;max-age=31536000</span>; <span style=color:#66d9ef>includeSubDomains&#34;</span> <span style=color:#e6db74>always</span>;
</span></span></code></pre></div><h3 id=3-配置缓存与压缩>3. 配置缓存与压缩<a href=#3-配置缓存与压缩 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>启用缓存头，优化静态资源缓存：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Cache-Control</span> <span style=color:#e6db74>&#34;public,</span> <span style=color:#e6db74>max-age=3600&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>expires</span> <span style=color:#e6db74>1h</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>启用 Gzip 压缩：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip_types</span> <span style=color:#e6db74>text/plain</span> <span style=color:#e6db74>application/json</span> <span style=color:#e6db74>application/javascript</span> <span style=color:#e6db74>text/css</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-代理-websocket-和-api>4. 代理 WebSocket 和 API<a href=#4-代理-websocket-和-api class=hanchor arialabel=Anchor>&#8983;</a></h3><p>如果有 WebSocket 或 API 后端，确保代理正确转发请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/ws/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Upgrade</span> $http_upgrade;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Connection</span> <span style=color:#e6db74>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/api/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:8081</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=五生产环境中的安全与优化>五、生产环境中的安全与优化<a href=#五生产环境中的安全与优化 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=1-防火墙规则>1. 防火墙规则<a href=#1-防火墙规则 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>仅允许 Cloudflare 的 IP 访问你的服务器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ufw allow proto tcp from 103.21.244.0/22 to any port <span style=color:#ae81ff>443</span>
</span></span></code></pre></div><h3 id=2-日志管理>2. 日志管理<a href=#2-日志管理 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>启用详细日志便于排查问题：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>access_log</span> <span style=color:#e6db74>/var/log/nginx/access.log</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>error_log</span> <span style=color:#e6db74>/var/log/nginx/error.log</span>;
</span></span></code></pre></div><h3 id=3-监控性能>3. 监控性能<a href=#3-监控性能 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>使用工具如 <code>htop</code> 和 <code>ngxtop</code> 实时监控 Nginx 的性能。</p><h3 id=4-配置-brotli-压缩>4. 配置 Brotli 压缩<a href=#4-配置-brotli-压缩 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>如果 Cloudflare 启用了 Brotli，Nginx 也可支持：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>brotli</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>brotli_types</span> <span style=color:#e6db74>text/plain</span> <span style=color:#e6db74>application/json</span> <span style=color:#e6db74>application/javascript</span> <span style=color:#e6db74>text/css</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=六总结>六、总结<a href=#六总结 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>通过将 Cloudflare 与 Nginx 集成，你可以大幅提升站点的性能与安全性。Cloudflare 提供了强大的网络层加速和防护，Nginx 则负责高效处理请求和业务逻辑。</p><p>无论是个人博客还是企业站点，这种架构都是现代 Web 开发的最佳选择。如果你有任何问题或更好的建议，欢迎在评论区讨论！ 😊</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://connorzhangyu.com/posts/%E4%BD%BF%E7%94%A8-nginx-+-cloudflare-+-docker-%E9%83%A8%E7%BD%B2-java-%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><span class=button__icon>←</span>
<span class=button__text>使用 Nginx + Cloudflare + Docker 部署 Java 服务的最佳实践</span>
</a></span><span class="button next"><a href=https://connorzhangyu.com/posts/%E5%A6%82%E4%BD%95%E8%A7%84%E5%88%92-aws-%E5%AD%A6%E4%B9%A0%E4%B8%8E%E8%AE%A4%E8%AF%81%E8%B7%AF%E5%BE%84%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%9E%B6%E6%9E%84%E5%B8%88/><span class=button__text>如何规划 AWS 学习与认证路径：从入门到架构师</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>